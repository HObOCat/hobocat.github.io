<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="RocketMQçš„ä½¿ç”¨ - https://hobocat.github.io/post/mq/2022-02-13-rocketmq/">
    <meta name="author" content="Jack - https://hobocat.github.io/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>RocketMQçš„ä½¿ç”¨</title>
    
    <base target="_blank">
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    
    
    
    
    <link rel="stylesheet" href="https://hobocat.github.io/style.min.94e7ed14b48117025ebd1148adc11f7268f1ebf50d97297ac663edf1aa6f52dc.css">
    
    <script>const DARK =  false ;</script>
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div class="container-floating-box">
	<div class="box box1"></div>
	<div class="box box11"></div>
	<div class="box box12"></div>
	<div class="box box2"></div>
	<div class="box box3"></div>
	<div class="box box4"></div>
	<div class="box box5"></div>
	<div class="box box6"></div>
	<div class="box box7"></div>
	<div class="box box8"></div>
	<div class="box box9"></div>
</div>
        <div class="cool-before" style="background: url('/imgs/bg/wallhaven-6qr21l.jpg') left top/100% no-repeat fixed;"></div>
        <div id="header" class=""><div class="container-header">

    
    
    
    <div class="right">
        
        <h1 class="title">RocketMQçš„ä½¿ç”¨</h1>
    
        
        
            <div id="toc">ğŸ“œ</div>
        
    </div>
</div>
</div>
        <div id="content">










<div class="container-main container-page ">

    

    
    
    
    

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="7409" width="12" height="12">
                <path
                    d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z"
                    p-id="7410" fill="#adb5bd"></path>
            </svg>
            2022-02-13&nbsp;&nbsp;&nbsp;
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="23838" width="11" height="11">
                <path
                    d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z"
                    p-id="23839" fill="#adb5bd"></path>
            </svg>
            2024-05-15&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="33866" width="12" height="12">
                <path
                    d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z"
                    fill="#adb5bd" p-id="33867"></path>
                <path
                    d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z"
                    fill="#adb5bd" p-id="33868"></path>
            </svg>
            11926 å­—</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="32892" width="12" height="12">
                <path
                    d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z"
                    p-id="32893" fill="#adb5bd"></path>
                <path
                    d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z"
                    p-id="32894" fill="#adb5bd"></path>
            </svg>
            24 åˆ†é’Ÿ</span>
        <div class="container-ctgtag">
	<div class="taxonomy">
		<div class="tag">
			
			
		</div>
	</div>
</div>
        
    </div>

    <div class="toc">
        <div class="container-page-operation">
	<div class="page-operation">
		<div><a href="/"><img src="/imgs/icons/home-2.svg" alt=""></a></div>
		<div><a href="/nav"><img src="/imgs/icons/iov-navigate-1.svg" alt=""></a></div>
		<div><a href="/wiki"><img src="/imgs/icons/wiki.svg" alt=""></a></div>
		<div><a href="/tags"><img src="/imgs/icons/treetags.svg" alt=""></a></div>
		<div id="light-dark"><a><img src="/imgs/icons/moon2.svg" alt=""></a></div>
		<div><a href="#"><img src="/imgs/icons/up2.svg" alt=""></a></div>
	</div>
</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€rocketmqä»‹ç»">ä¸€ã€RocketMQä»‹ç»</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#äºŒrocketmqé›†ç¾¤æ­å»º">äºŒã€RocketMQé›†ç¾¤æ­å»º</a>
      <ul>
        <li><a href="#å„è§’è‰²ä¹‹é—´çš„å…³ç³»">å„è§’è‰²ä¹‹é—´çš„å…³ç³»</a></li>
        <li><a href="#2master-2slaveçš„rocketmqæœåŠ¡æ­å»º">2Master-2Slaveçš„RocketMQæœåŠ¡æ­å»º</a></li>
        <li><a href="#é›†ç¾¤ç›‘æ§å¹³å°æ­å»º">é›†ç¾¤ç›‘æ§å¹³å°æ­å»º</a></li>
      </ul>
    </li>
    <li><a href="#ä¸‰rocketmqåŸºæœ¬ä½¿ç”¨">ä¸‰ã€RocketMQåŸºæœ¬ä½¿ç”¨</a>
      <ul>
        <li><a href="#å‘é€åŒæ­¥æ¶ˆæ¯">å‘é€åŒæ­¥æ¶ˆæ¯</a></li>
        <li><a href="#å‘é€å¼‚æ­¥æ¶ˆæ¯">å‘é€å¼‚æ­¥æ¶ˆæ¯</a></li>
        <li><a href="#å•å‘å‘é€æ¶ˆæ¯">å•å‘å‘é€æ¶ˆæ¯</a></li>
        <li><a href="#æ‰¹é‡å‘é€æ¶ˆæ¯">æ‰¹é‡å‘é€æ¶ˆæ¯</a></li>
        <li><a href="#é›†ç¾¤æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯">é›†ç¾¤æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯</a></li>
        <li><a href="#å¹¿æ’­æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯">å¹¿æ’­æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯</a></li>
        <li><a href="#é¡ºåºæ¶ˆæ¯">é¡ºåºæ¶ˆæ¯</a></li>
        <li><a href="#å»¶æ—¶æ¶ˆæ¯">å»¶æ—¶æ¶ˆæ¯</a></li>
        <li><a href="#è¿‡æ»¤æ¶ˆæ¯æ¶ˆè´¹">è¿‡æ»¤æ¶ˆæ¯æ¶ˆè´¹</a></li>
        <li><a href="#äº‹åŠ¡æ¶ˆæ¯">äº‹åŠ¡æ¶ˆæ¯</a></li>
      </ul>
    </li>
    <li><a href="#å››springbooté›†æˆrocketmq">å››ã€SpringBooté›†æˆRocketMQ</a>
      <ul>
        <li><a href="#å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯</a></li>
        <li><a href="#æ¶ˆè´¹æ¶ˆæ¯">æ¶ˆè´¹æ¶ˆæ¯</a></li>
      </ul>
    </li>
    <li><a href="#äº”é«˜çº§åŠŸèƒ½">äº”ã€é«˜çº§åŠŸèƒ½</a>
      <ul>
        <li><a href="#æ¶ˆæ¯å­˜å‚¨">æ¶ˆæ¯å­˜å‚¨</a></li>
        <li><a href="#é«˜å¯ç”¨æ€§æœºåˆ¶">é«˜å¯ç”¨æ€§æœºåˆ¶</a></li>
        <li><a href="#è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</a></li>
        <li><a href="#æ¶ˆæ¯é‡è¯•">æ¶ˆæ¯é‡è¯•</a></li>
        <li><a href="#æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</a></li>
        <li><a href="#æ¶ˆè´¹å¹‚ç­‰">æ¶ˆè´¹å¹‚ç­‰</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  '>
        <h2 id="ä¸€rocketmqä»‹ç»">ä¸€ã€RocketMQä»‹ç»</h2>
<h4 id="mqä½œç”¨">MQä½œç”¨</h4>
<p><img src="/img/rocketmq/MQ-worker.png" alt="MQ-worker"></p>
<p>MQæ˜¯ä¸€ç§&quot;&ldquo;å…ˆè¿›å…ˆå‡º&quot;çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªä½œç”¨</p>
<ul>
<li>åº”ç”¨è§£è€¦</li>
</ul>
<p>â€‹		ç³»ç»Ÿçš„è€¦åˆæ€§è¶Šé«˜ï¼Œå®¹é”™æ€§å°±è¶Šä½ã€‚ä¾‹å¦‚ä¸‹è®¢å•å¦‚æœRPCè°ƒç”¨ä»“å‚¨ç³»ç»Ÿï¼Œå¦‚æœä»“å‚¨ç³»ç»Ÿå‡ºåº“æ¨¡å—å¼‚å¸¸å°†å¯¼è‡´è®¢å•æ— æ³•åˆ›å»ºï¼Œè¿™åŸºæœ¬æ˜¯æˆ‘ä»¬æ— æ³•å®¹å¿çš„ã€‚æ‰€ä»¥å¯ä»¥é‡‡ç”¨MQçš„æ–¹å¼ï¼Œæ¥æ”¶åˆ›å»ºè®¢å•æˆåŠŸçš„æ¶ˆæ¯è°ƒç”¨ä»“å‚¨å‡ºåº“ã€‚</p>
<ul>
<li>æµé‡å‰Šå³°</li>
</ul>
<p>â€‹		åº”ç”¨ç³»ç»Ÿå¦‚æœé‡åˆ°ç³»ç»Ÿè¯·æ±‚æµé‡çš„ç¬é—´çŒ›å¢ï¼Œæœ‰å¯èƒ½ä¼šå°†ç³»ç»Ÿå‹å®ã€‚æœ‰äº†æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å°†å¤§é‡è¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œåˆ†æ•£åˆ°å¾ˆé•¿ä¸€æ®µæ—¶é—´å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æåˆ°ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚</p>
<ul>
<li>å¼‚æ­¥æ‰§è¡Œ</li>
</ul>
<p>â€‹		é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è®©æ•°æ®åœ¨å¤šä¸ªç³»ç»Ÿæ›´åŠ ä¹‹é—´è¿›è¡Œæµé€šã€‚æ•°æ®çš„äº§ç”Ÿæ–¹ä¸éœ€è¦å…³å¿ƒè°æ¥ä½¿ç”¨æ•°æ®ï¼Œåªéœ€è¦å°†æ•°æ®å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ•°æ®ä½¿ç”¨æ–¹ç›´æ¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç›´æ¥è·å–æ•°æ®å³å¯ã€‚</p>
<h4 id="å„ç§mqäº§å“çš„æ¯”è¾ƒ">å„ç§MQäº§å“çš„æ¯”è¾ƒ</h4>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>kafka</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å¼€å‘è¯­è¨€</strong></td>
<td>java</td>
<td>erlang</td>
<td>java</td>
<td>scala</td>
</tr>
<tr>
<td><strong>å•æœºååé‡</strong></td>
<td>ä¸‡çº§</td>
<td>ä¸‡çº§</td>
<td>10ä¸‡çº§</td>
<td>10ä¸‡çº§</td>
</tr>
<tr>
<td><strong>æ—¶æ•ˆæ€§</strong></td>
<td>msçº§</td>
<td>usçº§</td>
<td>msçº§</td>
<td>msçº§ä»¥å†…</td>
</tr>
<tr>
<td><strong>å¯ç”¨æ€§</strong></td>
<td>é«˜(ä¸»ä»æ¶æ„)</td>
<td>é«˜(ä¸»ä»æ¶æ„)</td>
<td>éå¸¸é«˜(åˆ†å¸ƒå¼æ¶æ„)</td>
<td>éå¸¸é«˜(åˆ†å¸ƒå¼æ¶æ„)</td>
</tr>
<tr>
<td><strong>åŠŸèƒ½ç‰¹æ€§</strong></td>
<td>æˆç†Ÿçš„äº§å“ï¼Œåœ¨å¾ˆå¤šå…¬å¸å¾—åˆ°åº”ç”¨ï¼›æœ‰è¾ƒå¤šçš„æ–‡æ¡£ï¼›å„ç§åè®®æ”¯æŒè¾ƒå¥½</td>
<td>åŸºäºerlangå¼€å‘ï¼Œæ‰€ä»¥å¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œæ€§èƒ½æå…¶å¥½ï¼Œå»¶æ—¶å¾ˆä½;ç®¡ç†ç•Œé¢è¾ƒä¸°å¯Œ</td>
<td>MQåŠŸèƒ½æ¯”è¾ƒå®Œå¤‡ï¼Œæ‰©å±•æ€§ä½³</td>
<td>åªæ”¯æŒä¸»è¦çš„MQåŠŸèƒ½ï¼Œåƒä¸€äº›æ¶ˆæ¯æŸ¥è¯¢ï¼Œæ¶ˆæ¯å›æº¯ç­‰åŠŸèƒ½æ²¡æœ‰æä¾›ï¼Œæ¯•ç«Ÿæ˜¯ä¸ºå¤§æ•°æ®å‡†å¤‡çš„ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸåº”ç”¨å¹¿</td>
</tr>
</tbody>
</table>
<h4 id="rocketmqå„è§’è‰²ä»‹ç»">RocketMQå„è§’è‰²ä»‹ç»</h4>
<table>
<thead>
<tr>
<th>è§’è‰²</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>Producer</td>
<td>æ¶ˆæ¯çš„å‘é€è€…</td>
</tr>
<tr>
<td>Consumer</td>
<td>æ¶ˆæ¯æ¥æ”¶è€…</td>
</tr>
<tr>
<td>Broker</td>
<td>æš‚å­˜å’Œä¼ è¾“æ¶ˆæ¯</td>
</tr>
<tr>
<td>NameServer</td>
<td>ç®¡ç†Brokerï¼Œå‘é€è€…å’Œæ¶ˆè´¹è€…ä»NameServeræ‰¾åˆ°å¯¹åº”çš„Broker</td>
</tr>
<tr>
<td>Topic</td>
<td>æ¶ˆæ¯ä¸»é¢˜</td>
</tr>
<tr>
<td>Message Queue</td>
<td>ç›¸å½“äºæ˜¯Topicçš„åˆ†åŒº</td>
</tr>
</tbody>
</table>
<img src="/img/rocketmq/RocketMQ-role.png" alt="RocketMQ-role" style="zoom:80%;" />
<h2 id="äºŒrocketmqé›†ç¾¤æ­å»º">äºŒã€RocketMQé›†ç¾¤æ­å»º</h2>
<p>å‰ç½®æ¡ä»¶ï¼šJDK1.8</p>
<p>RocketMQ<a href="https://rocketmq.apache.org/">ä¸‹è½½åœ°å€</a>ã€RocketMQ-Externalsï¼ˆGUIç®¡ç†ç•Œé¢ï¼‰<a href="https://github.com/apache/rocketmq-dashboard">ä¸‹è½½åœ°å€</a></p>
<h3 id="å„è§’è‰²ä¹‹é—´çš„å…³ç³»">å„è§’è‰²ä¹‹é—´çš„å…³ç³»</h3>
<ul>
<li>
<p>NameServeræ˜¯ä¸€ä¸ªå‡ ä¹æ— çŠ¶æ€èŠ‚ç‚¹ã€‚å¯é›†ç¾¤éƒ¨ç½²ï¼ŒèŠ‚ç‚¹ä¹‹é—´æ— ä»»ä½•ä¿¡æ¯åŒæ­¥ã€‚</p>
</li>
<li>
<p>Brokeréƒ¨ç½²ç›¸å¯¹å¤æ‚ï¼ŒBrokeråˆ†ä¸ºMasterä¸Slaveï¼Œä¸€ä¸ªMasterå¯ä»¥å¯¹åº”å¤šä¸ªSlaveï¼Œä½†æ˜¯ä¸€ä¸ªSlaveåªèƒ½å¯¹åº”ä¸€ä¸ªMasterï¼ŒMasterä¸Slaveçš„å¯¹åº”å…³ç³»é€šè¿‡æŒ‡å®šç›¸åŒçš„BrokerNameï¼Œä¸åŒçš„BrokerIdæ¥å®šä¹‰ï¼ŒBrokerIdä¸º0è¡¨ç¤ºMasterï¼Œé0è¡¨ç¤ºSlaveã€‚Masterä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªã€‚æ¯ä¸ªBrokerä¸NameServeré›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶æ³¨å†ŒTopicä¿¡æ¯åˆ°æ‰€æœ‰NameServerã€‚</p>
</li>
<li>
<p>Producerä¸NameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»NameServerå–Topicè·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›TopicæœåŠ¡çš„Masterå»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘Masterå‘é€å¿ƒè·³ã€‚Producerå®Œå…¨æ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½²ã€‚</p>
</li>
<li>
<p>Consumerä¸NameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»NameServerå–Topicè·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›TopicæœåŠ¡çš„Masterã€Slaveå»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘Masterã€Slaveå‘é€å¿ƒè·³ã€‚Consumeræ—¢å¯ä»¥ä»Masterè®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä»Slaveè®¢é˜…æ¶ˆæ¯ï¼Œè®¢é˜…è§„åˆ™ç”±Brokeré…ç½®å†³å®šã€‚</p>
</li>
</ul>
<h3 id="2master-2slaveçš„rocketmqæœåŠ¡æ­å»º">2Master-2Slaveçš„RocketMQæœåŠ¡æ­å»º</h3>
<p><img src="/img/rocketmq/rmq-basic-arc.png" alt="rmq-basic-arc"></p>
<p>è§’è‰²ä»‹ç»</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>è§’è‰²</th>
<th>æ¶æ„æ¨¡å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.22.162</td>
<td>nameserverã€brokerserver</td>
<td>Master1ã€Slave2ã€NameServer</td>
</tr>
<tr>
<td>192.168.22.163</td>
<td>nameserverã€brokerserver</td>
<td>Master2ã€Slave1ã€NameServer</td>
</tr>
</tbody>
</table>
<p>ç¬¬ä¸€æ­¥ï¼šä¸¤å°æœºå™¨éƒ½è§£å‹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>unzip rocketmq-all-<span style="color:#000;font-weight:bold">[</span>version<span style="color:#000;font-weight:bold">]</span>-bin-release.zip
</span></span><span style="display:flex;"><span>mv rocketmq-<span style="color:#000;font-weight:bold">[</span>version<span style="color:#000;font-weight:bold">]</span> /opt/module
</span></span><span style="display:flex;"><span>mv /opt/module/rocketmq-<span style="color:#000;font-weight:bold">[</span>version<span style="color:#000;font-weight:bold">]</span> /opt/module/rocketmq
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒæ­¥ï¼šä¸¤å°æœºå™¨éƒ½åˆ›å»ºæ¶ˆæ¯å­˜å‚¨ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 192.168.22.162</span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/rocketmq/store/broker-a
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/rocketmq/store/broker-b-s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 192.168.22.163</span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/rocketmq/store/broker-b
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/rocketmq/store/broker-a-s
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸‰æ­¥ï¼š</p>
<ul>
<li>é…ç½®<code>192.168.22.162</code>çš„<code>master1</code>ï¼Œç¼–è¾‘<code>/opt/module/rocketmq/conf/2m-2s-sync/broker-a.properties </code>ï¼ˆå¯é‡å‘½åï¼‰ï¼Œåˆ é™¤<code> broker-a-s.properties</code></li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‰€å±é›†ç¾¤åå­—</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerClusterName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">rocketmq-cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># brokeråå­—ï¼Œæ³¨æ„æ­¤å¤„ä¸åŒçš„é…ç½®æ–‡ä»¶å¡«å†™çš„ä¸ä¸€æ ·</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">broker-a</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 0è¡¨ç¤ºMasterï¼Œ1è¡¨ç¤ºSlave</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerId</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">0</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nameServeråœ°å€ï¼Œåˆ†å·åˆ†å‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">namesrvAddr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">192.168.22.162:9876;192.168.22.163:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæœåŠ¡å™¨ä¸å­˜åœ¨çš„topicï¼Œé»˜è®¤åˆ›å»ºçš„é˜Ÿåˆ—æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">defaultTopicQueueNums</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºTopicï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateTopicEnable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºè®¢é˜…ç»„ï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateSubscriptionGroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Brokerå¯¹å¤–æœåŠ¡çš„ç›‘å¬ç«¯å£ï¼Œä¸å¯é‡å¤</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">listenPort</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">10911</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ é™¤æ–‡ä»¶æ—¶é—´ç‚¹ï¼Œé»˜è®¤å‡Œæ™¨4ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">deleteWhen</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">04</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼Œé»˜è®¤48å°æ—¶</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">fileReservedTime</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">120</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># commitLogæ¯ä¸ªæ–‡ä»¶çš„å¤§å°é»˜è®¤1G</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeCommitLog</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># consumeQueueæ¯ä¸ªæ–‡ä»¶é»˜è®¤å­˜30Wæ¡ï¼Œæ ¹æ®ä¸šåŠ¡æƒ…å†µè°ƒæ•´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeConsumeQueue</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">300000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#destroyMapedFileIntervalForcibly=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#redeleteHangedFileInterval=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ£€æµ‹ç‰©ç†æ–‡ä»¶ç£ç›˜ç©ºé—´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">diskMaxUsedSpaceRatio</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">88</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å­˜å‚¨è·¯å¾„</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">storePathRootDir</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">/opt/module/rocketmq/store/broker-a</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é™åˆ¶çš„æ¶ˆæ¯å¤§å°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">maxMessageSize</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogLeastPages=4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueLeastPages=2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogThoroughInterval=10000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueThoroughInterval=60000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Broker çš„è§’è‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_MASTER å¼‚æ­¥å¤åˆ¶Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_MASTER åŒæ­¥åŒå†™Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SLAVE</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerRole</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">SYNC_MASTER</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ·ç›˜æ–¹å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_FLUSH å¼‚æ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_FLUSH åŒæ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">flushDiskType</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">SYNC_FLUSH</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#checkTransactionMessageEnable=false</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#sendMessageThreadPoolNums=128</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‹‰æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#pullMessageThreadPoolNums=128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é…ç½®<code>192.168.22.162</code>çš„<code>slave2</code>ï¼Œç¼–è¾‘<code>/opt/module/rocketmq/conf/2m-2s-sync/broker-b-s.properties </code>ï¼ˆå¯é‡å‘½åï¼‰ï¼Œåˆ é™¤<code> broker-b.properties</code></li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‰€å±é›†ç¾¤åå­—</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerClusterName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">rocketmq-cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># brokeråå­—ï¼Œæ³¨æ„æ­¤å¤„ä¸åŒçš„é…ç½®æ–‡ä»¶å¡«å†™çš„ä¸ä¸€æ ·</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">broker-b</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 0è¡¨ç¤ºMasterï¼Œ1è¡¨ç¤ºSlave</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerId</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">1</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nameServeråœ°å€ï¼Œåˆ†å·åˆ†å‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">namesrvAddr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">192.168.22.162:9876;192.168.22.163:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæœåŠ¡å™¨ä¸å­˜åœ¨çš„topicï¼Œé»˜è®¤åˆ›å»ºçš„é˜Ÿåˆ—æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">defaultTopicQueueNums</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºTopicï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateTopicEnable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºè®¢é˜…ç»„ï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateSubscriptionGroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Broker å¯¹å¤–æœåŠ¡çš„ç›‘å¬ç«¯å£</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">listenPort</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">11011</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ é™¤æ–‡ä»¶æ—¶é—´ç‚¹ï¼Œé»˜è®¤å‡Œæ™¨ 4ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">deleteWhen</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">04</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼Œé»˜è®¤ 48 å°æ—¶</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">fileReservedTime</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">120</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># commitLogæ¯ä¸ªæ–‡ä»¶çš„å¤§å°é»˜è®¤1G</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeCommitLog</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ConsumeQueueæ¯ä¸ªæ–‡ä»¶é»˜è®¤å­˜30Wæ¡ï¼Œæ ¹æ®ä¸šåŠ¡æƒ…å†µè°ƒæ•´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeConsumeQueue</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">300000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#destroyMapedFileIntervalForcibly=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#redeleteHangedFileInterval=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ£€æµ‹ç‰©ç†æ–‡ä»¶ç£ç›˜ç©ºé—´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">diskMaxUsedSpaceRatio</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">88</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å­˜å‚¨è·¯å¾„</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">storePathRootDir</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">/opt/module/rocketmq/store/broker-b-s</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é™åˆ¶çš„æ¶ˆæ¯å¤§å°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">maxMessageSize</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogLeastPages=4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueLeastPages=2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogThoroughInterval=10000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueThoroughInterval=60000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Broker çš„è§’è‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_MASTER å¼‚æ­¥å¤åˆ¶Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_MASTER åŒæ­¥åŒå†™Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SLAVE</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerRole</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">SLAVE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ·ç›˜æ–¹å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_FLUSH å¼‚æ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_FLUSH åŒæ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">flushDiskType</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">ASYNC_FLUSH</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#checkTransactionMessageEnable=false</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#sendMessageThreadPoolNums=128</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‹‰æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#pullMessageThreadPoolNums=128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é…ç½®<code>192.168.22.163</code>çš„<code>master2</code>ï¼Œç¼–è¾‘<code>/opt/module/rocketmq/conf/2m-2s-sync/broker-b.properties </code>ï¼ˆå¯é‡å‘½åï¼‰ï¼Œåˆ é™¤<code> broker-b-s.properties</code></li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‰€å±é›†ç¾¤åå­—</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerClusterName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">rocketmq-cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># brokeråå­—ï¼Œæ³¨æ„æ­¤å¤„ä¸åŒçš„é…ç½®æ–‡ä»¶å¡«å†™çš„ä¸ä¸€æ ·</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">broker-b</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 0è¡¨ç¤ºMasterï¼Œ1è¡¨ç¤ºSlave</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerId</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">0</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nameServeråœ°å€ï¼Œåˆ†å·åˆ†å‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">namesrvAddr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">192.168.22.162:9876;192.168.22.163:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæœåŠ¡å™¨ä¸å­˜åœ¨çš„topicï¼Œé»˜è®¤åˆ›å»ºçš„é˜Ÿåˆ—æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">defaultTopicQueueNums</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºTopicï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateTopicEnable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºè®¢é˜…ç»„ï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateSubscriptionGroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Brokerå¯¹å¤–æœåŠ¡çš„ç›‘å¬ç«¯å£ï¼Œä¸å¯é‡å¤</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">listenPort</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">10911</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ é™¤æ–‡ä»¶æ—¶é—´ç‚¹ï¼Œé»˜è®¤å‡Œæ™¨4ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">deleteWhen</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">04</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼Œé»˜è®¤48å°æ—¶</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">fileReservedTime</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">120</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># commitLogæ¯ä¸ªæ–‡ä»¶çš„å¤§å°é»˜è®¤1G</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeCommitLog</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># consumeQueueæ¯ä¸ªæ–‡ä»¶é»˜è®¤å­˜30Wæ¡ï¼Œæ ¹æ®ä¸šåŠ¡æƒ…å†µè°ƒæ•´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeConsumeQueue</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">300000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#destroyMapedFileIntervalForcibly=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#redeleteHangedFileInterval=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ£€æµ‹ç‰©ç†æ–‡ä»¶ç£ç›˜ç©ºé—´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">diskMaxUsedSpaceRatio</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">88</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å­˜å‚¨è·¯å¾„</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">storePathRootDir</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">/opt/module/rocketmq/store/broker-b</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é™åˆ¶çš„æ¶ˆæ¯å¤§å°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">maxMessageSize</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogLeastPages=4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueLeastPages=2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogThoroughInterval=10000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueThoroughInterval=60000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Broker çš„è§’è‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_MASTER å¼‚æ­¥å¤åˆ¶Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_MASTER åŒæ­¥åŒå†™Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SLAVE</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerRole</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">SYNC_MASTER</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ·ç›˜æ–¹å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_FLUSH å¼‚æ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_FLUSH åŒæ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">flushDiskType</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">SYNC_FLUSH</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#checkTransactionMessageEnable=false</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#sendMessageThreadPoolNums=128</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‹‰æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#pullMessageThreadPoolNums=128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é…ç½®<code>192.168.22.163</code>çš„<code>slave1</code>ï¼Œç¼–è¾‘<code>/opt/module/rocketmq/conf/2m-2s-sync/broker-a-s.properties </code>ï¼ˆå¯é‡å‘½åï¼‰ï¼Œåˆ é™¤<code> broker-a.properties</code></li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‰€å±é›†ç¾¤åå­—</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerClusterName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">rocketmq-cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># brokeråå­—ï¼Œæ³¨æ„æ­¤å¤„ä¸åŒçš„é…ç½®æ–‡ä»¶å¡«å†™çš„ä¸ä¸€æ ·</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerName</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">broker-a</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 0è¡¨ç¤ºMasterï¼Œ1è¡¨ç¤ºSlave</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerId</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">1</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nameServeråœ°å€ï¼Œåˆ†å·åˆ†å‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">namesrvAddr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">192.168.22.162:9876;192.168.22.163:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæœåŠ¡å™¨ä¸å­˜åœ¨çš„topicï¼Œé»˜è®¤åˆ›å»ºçš„é˜Ÿåˆ—æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">defaultTopicQueueNums</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºTopicï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateTopicEnable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å…è®¸Brokerè‡ªåŠ¨åˆ›å»ºè®¢é˜…ç»„ï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autoCreateSubscriptionGroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Broker å¯¹å¤–æœåŠ¡çš„ç›‘å¬ç«¯å£</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">listenPort</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">11011</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ é™¤æ–‡ä»¶æ—¶é—´ç‚¹ï¼Œé»˜è®¤å‡Œæ™¨ 4ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">deleteWhen</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">04</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼Œé»˜è®¤ 48 å°æ—¶</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">fileReservedTime</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">120</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># commitLogæ¯ä¸ªæ–‡ä»¶çš„å¤§å°é»˜è®¤1G</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeCommitLog</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ConsumeQueueæ¯ä¸ªæ–‡ä»¶é»˜è®¤å­˜30Wæ¡ï¼Œæ ¹æ®ä¸šåŠ¡æƒ…å†µè°ƒæ•´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">mapedFileSizeConsumeQueue</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">300000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#destroyMapedFileIntervalForcibly=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#redeleteHangedFileInterval=120000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ£€æµ‹ç‰©ç†æ–‡ä»¶ç£ç›˜ç©ºé—´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">diskMaxUsedSpaceRatio</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">88</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å­˜å‚¨è·¯å¾„</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">storePathRootDir</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">/opt/module/rocketmq/store/broker-a-s</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é™åˆ¶çš„æ¶ˆæ¯å¤§å°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">maxMessageSize</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogLeastPages=4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueLeastPages=2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushCommitLogThoroughInterval=10000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#flushConsumeQueueThoroughInterval=60000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Broker çš„è§’è‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_MASTER å¼‚æ­¥å¤åˆ¶Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_MASTER åŒæ­¥åŒå†™Master</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SLAVE</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">brokerRole</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">SLAVE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ·ç›˜æ–¹å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - ASYNC_FLUSH å¼‚æ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - SYNC_FLUSH åŒæ­¥åˆ·ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">flushDiskType</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">ASYNC_FLUSH</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#checkTransactionMessageEnable=false</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#sendMessageThreadPoolNums=128</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‹‰æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#pullMessageThreadPoolNums=128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬å››æ­¥ï¼šä¿®æ”¹å¯åŠ¨è„šæœ¬æ–‡ä»¶</p>
<p>ä¿®æ”¹<code>/opt/module/rocketmq/bin/runbroker.sh</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#===================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å¼€å‘ç¯å¢ƒé…ç½® JVM Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">JAVA_OPT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;</span><span style="color:#d14">${</span><span style="color:#008080">JAVA_OPT</span><span style="color:#d14">}</span><span style="color:#d14"> -server -Xms256m -Xmx256m -Xmn128m&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹<code>/opt/module/rocketmq/bin/runserver.sh</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#===================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å¼€å‘ç¯å¢ƒé…ç½® JVM Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">JAVA_OPT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;</span><span style="color:#d14">${</span><span style="color:#008080">JAVA_OPT</span><span style="color:#d14">}</span><span style="color:#d14"> -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äº”æ­¥ï¼šå¯åŠ¨NameServeé›†ç¾¤ï¼Œåˆ†åˆ«åœ¨ä¸¤å°æœºå™¨éƒ½å¯åŠ¨NameServer</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 1.å¯åŠ¨NameServer</span>
</span></span><span style="display:flex;"><span>nohup sh mqnamesrv &gt; mqnamesrv.log  2&gt;&amp;<span style="color:#099">1</span> &amp;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æŸ¥çœ‹è¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>jps
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬å…­æ­¥ï¼šåœ¨192.168.22.162ä¸Šå¯åŠ¨master1å’Œslave2</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-a.properties &gt; broker-a.log  2&gt;&amp;<span style="color:#099">1</span> &amp;
</span></span><span style="display:flex;"><span>nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-b-s.properties &gt; broker-b-s.log  2&gt;&amp;<span style="color:#099">1</span> &amp;
</span></span><span style="display:flex;"><span>jps
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸ƒæ­¥ï¼šåœ¨192.168.22.163ä¸Šå¯åŠ¨master2å’Œslave1</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-b.properties &gt; broker-b.log  2&gt;&amp;<span style="color:#099">1</span> &amp;
</span></span><span style="display:flex;"><span>nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-a-s.properties &gt; broker-a-s.log  2&gt;&amp;<span style="color:#099">1</span> &amp;
</span></span><span style="display:flex;"><span>jps
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å…³é—­brokerå‘½ä»¤ï¼šsh mqshutdown broker</p>
</blockquote>
<h3 id="é›†ç¾¤ç›‘æ§å¹³å°æ­å»º">é›†ç¾¤ç›‘æ§å¹³å°æ­å»º</h3>
<p><a href="https://github.com/apache/rocketmq-dashboard">ä¸‹è½½æºç åŒ…</a>ï¼Œä¿®æ”¹<code>application.properties</code>æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">rocketmq.config.namesrvAddr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">192.168.22.162:9876;192.168.22.163:9876</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰“åŒ…ç¼–è¯‘è¿è¡Œå³å¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mvn clean package -Dmaven.test.skip<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>java -jar target/rocketmq-dashboard-<span style="color:#000;font-weight:bold">[</span>version<span style="color:#000;font-weight:bold">]</span>.jar
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¸‰rocketmqåŸºæœ¬ä½¿ç”¨">ä¸‰ã€RocketMQåŸºæœ¬ä½¿ç”¨</h2>
<h3 id="å‘é€åŒæ­¥æ¶ˆæ¯">å‘é€åŒæ­¥æ¶ˆæ¯</h3>
<p>å¯é æ€§çš„åŒæ­¥åé¦ˆå‘é€ç»“æœ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">syncSendMessageTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;sync_send_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>10;<span style="color:#bbb"> </span>i<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;sync_product&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Hello RocketMQ Sync Send Message &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>i));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>SendResult<span style="color:#bbb"> </span>sendResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>producer.<span style="color:#008080">send</span>(message);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;sendResult = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(5);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å‘é€å¼‚æ­¥æ¶ˆæ¯">å‘é€å¼‚æ­¥æ¶ˆæ¯</h3>
<p>å¼‚æ­¥æ¥æ”¶å‘é€çš„ç»“æœï¼Œä¸é˜»å¡ï¼Œå¿«é€Ÿå“åº”</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">asyncSendMessageTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;async_send_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>10;<span style="color:#bbb"> </span>i<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;async_product&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Hello RocketMQ Async Send Message &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>i));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>producer.<span style="color:#008080">send</span>(message,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>SendCallback()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#998;font-style:italic">// æˆåŠŸå¤„ç†</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onSuccess</span>(SendResult<span style="color:#bbb"> </span>sendResult)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;act=onSuccess sendResult = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#998;font-style:italic">// å¼‚å¸¸å¤„ç†</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onException</span>(Throwable<span style="color:#bbb"> </span>throwable)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;act=onException throwable = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(throwable));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(5);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å•å‘å‘é€æ¶ˆæ¯">å•å‘å‘é€æ¶ˆæ¯</h3>
<p>å‘é€æ¶ˆæ¯ï¼Œå¯¹å‘é€ç»“æœä¸å…³å¿ƒ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onewaySendMessageTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;oneway_send_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>10;<span style="color:#bbb"> </span>i<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;oneway_product&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Hello RocketMQ Oneway Send Message &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>i));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯ï¼Œ ä¸å…³å¿ƒå‘é€ç»“æœç›´æ¥è¿”å›</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>producer.<span style="color:#008080">sendOneway</span>(message);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(5);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‰¹é‡å‘é€æ¶ˆæ¯">æ‰¹é‡å‘é€æ¶ˆæ¯</h3>
<p>æ‰¹é‡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸€æ¬¡ä¸èƒ½è¶…è¿‡4M</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">batchSendMessageTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;batch_send_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// æ„å»ºæ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Message<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>messages<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>messages.<span style="color:#008080">add</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;batch_topic&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Batch Message 0&#34;</span>)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>messages.<span style="color:#008080">add</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;batch_topic&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Batch Message 1&#34;</span>)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>messages.<span style="color:#008080">add</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;batch_topic&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Batch Message 2&#34;</span>)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯ï¼Œ ä¸å…³å¿ƒå‘é€ç»“æœç›´æ¥è¿”å›</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>SendResult<span style="color:#bbb"> </span>sendResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>producer.<span style="color:#008080">send</span>(messages);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;sendResult = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(5);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ¶ˆæ¯è¶…è¿‡äº†4Mï¼Œå¯ä»¥ç”¨å¦‚ä¸‹å·¥å…·ç±»åˆ‡åˆ†</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ListSplitter</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>Iterator<span style="color:#000;font-weight:bold">&lt;</span>List<span style="color:#000;font-weight:bold">&lt;</span>Message<span style="color:#000;font-weight:bold">&gt;&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>SIZE_LIMIT<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>1024<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span>1024<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span>4;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">final</span><span style="color:#bbb"> </span>List<span style="color:#000;font-weight:bold">&lt;</span>Message<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>messages;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>currIndex;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">ListSplitter</span>(List<span style="color:#000;font-weight:bold">&lt;</span>Message<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>messages)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">this</span>.<span style="color:#008080">messages</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>messages;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">boolean</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">hasNext</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>currIndex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>messages.<span style="color:#008080">size</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>List<span style="color:#000;font-weight:bold">&lt;</span>Message<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">next</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>nextIndex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>currIndex;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>totalSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(;<span style="color:#bbb"> </span>nextIndex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>messages.<span style="color:#008080">size</span>();<span style="color:#bbb"> </span>nextIndex<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>messages.<span style="color:#008080">get</span>(nextIndex);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>tmpSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getTopic</span>().<span style="color:#008080">length</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getBody</span>().<span style="color:#008080">length</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>Map<span style="color:#000;font-weight:bold">&lt;</span>String,<span style="color:#bbb"> </span>String<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>properties<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getProperties</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(Map.<span style="color:#008080">Entry</span><span style="color:#000;font-weight:bold">&lt;</span>String,<span style="color:#bbb"> </span>String<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>entry<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>properties.<span style="color:#008080">entrySet</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>tmpSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+=</span><span style="color:#bbb"> </span>entry.<span style="color:#008080">getKey</span>().<span style="color:#008080">length</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>entry.<span style="color:#008080">getValue</span>().<span style="color:#008080">length</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>tmpSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>tmpSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>20;<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">// å¢åŠ æ—¥å¿—çš„å¼€é”€20å­—èŠ‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(tmpSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>SIZE_LIMIT)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// å•ä¸ªæ¶ˆæ¯è¶…è¿‡äº†æœ€å¤§çš„é™åˆ¶</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// å¿½ç•¥,å¦åˆ™ä¼šé˜»å¡åˆ†è£‚çš„è¿›ç¨‹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(nextIndex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-</span><span style="color:#bbb"> </span>currIndex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">==</span><span style="color:#bbb"> </span>0)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#998;font-style:italic">// å‡å¦‚ä¸‹ä¸€ä¸ªå­åˆ—è¡¨æ²¡æœ‰å…ƒç´ ,åˆ™æ·»åŠ è¿™ä¸ªå­åˆ—è¡¨ç„¶åé€€å‡ºå¾ªç¯,å¦åˆ™åªæ˜¯é€€å‡ºå¾ªç¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>nextIndex<span style="color:#000;font-weight:bold">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">break</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(tmpSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>totalSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>SIZE_LIMIT)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">break</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>totalSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+=</span><span style="color:#bbb"> </span>tmpSize;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>List<span style="color:#000;font-weight:bold">&lt;</span>Message<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>subList<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>messages.<span style="color:#008080">subList</span>(currIndex,<span style="color:#bbb"> </span>nextIndex);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>currIndex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>nextIndex;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>subList;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é›†ç¾¤æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯">é›†ç¾¤æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯</h3>
<p>æ¶ˆè´¹è€…é‡‡ç”¨é›†ç¾¤æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ï¼ŒåŒä¸€ä¸ªç»„å¤šä¸ªæ¶ˆè´¹è€…å…±åŒæ¶ˆè´¹é˜Ÿåˆ—æ¶ˆæ¯ï¼ˆå³å‘é€10ä¸ªæ¶ˆæ¯ï¼Œä¸¤ä¸ªä¸åŒç»„ï¼Œæ¯ç»„éƒ½éƒ¨ç½²äº†Nå°ï¼Œæ¯ç»„éƒ½æ¶ˆè´¹10ä¸ªæ¶ˆæ¯ï¼‰ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„æ¶ˆè´¹æ¨¡å¼</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">clusterConsumerTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…,æŒ‡å®šç»„å</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQPushConsumer<span style="color:#bbb"> </span>consumer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQPushConsumer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#d14">&#34;clusterConsumerGroup&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¢é˜…Topic</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">subscribe</span>(<span style="color:#d14">&#34;sync_product&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// é›†ç¾¤æ¨¡å¼æ¶ˆè´¹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setMessageModel</span>(MessageModel.<span style="color:#008080">CLUSTERING</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// ä»é˜Ÿåˆ—å°¾éƒ¨æ¶ˆè´¹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setConsumeFromWhere</span>(ConsumeFromWhere.<span style="color:#008080">CONSUME_FROM_LAST_OFFSET</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">registerMessageListener</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MessageListenerConcurrently()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>ConsumeConcurrentlyStatus<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">consumeMessage</span>(List<span style="color:#000;font-weight:bold">&lt;</span>MessageExt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>msgs,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                                    </span>ConsumeConcurrentlyContext<span style="color:#bbb"> </span>context)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(MessageExt<span style="color:#bbb"> </span>msg<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>msgs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">printf</span>(<span style="color:#d14">&#34;topic=%s tag=%s msgId=%s msgKey=%s msgBody=%s \n&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                          </span>msg.<span style="color:#008080">getTopic</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getTags</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getMsgId</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getKeys</span>(),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                          </span>JSON.<span style="color:#008080">parseObject</span>(msg.<span style="color:#008080">getBody</span>(),<span style="color:#bbb"> </span>String.<span style="color:#008080">class</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>ConsumeConcurrentlyStatus.<span style="color:#008080">CONSUME_SUCCESS</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//å¯åŠ¨æ¶ˆæ¯è€…</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¹¿æ’­æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯">å¹¿æ’­æ¨¡å¼æ¶ˆè´¹æ¶ˆæ¯</h3>
<p>æ¶ˆè´¹è€…é‡‡ç”¨å¹¿æ’­æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ¯ä¸ªéƒ¨ç½²å®ä¾‹éƒ½æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼ˆå³åªè¦æœ‰å®ä¾‹éƒ½æ¶ˆè´¹ï¼Œæ¯ä¸ªå®ä¾‹ä¼šæ¶ˆè´¹åˆ°ç›¸åŒçš„æ¶ˆæ¯ï¼‰</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">broadcastConsumerTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…,æŒ‡å®šç»„å</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQPushConsumer<span style="color:#bbb"> </span>consumer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQPushConsumer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#d14">&#34;broadcastConsumerGroup&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¢é˜…Topic</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">subscribe</span>(<span style="color:#d14">&#34;sync_product&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¹¿æ’­æ¨¡å¼æ¶ˆè´¹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setMessageModel</span>(MessageModel.<span style="color:#008080">BROADCASTING</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// ä»é˜Ÿåˆ—å°¾éƒ¨æ¶ˆè´¹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setConsumeFromWhere</span>(ConsumeFromWhere.<span style="color:#008080">CONSUME_FROM_LAST_OFFSET</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">registerMessageListener</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MessageListenerConcurrently()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>ConsumeConcurrentlyStatus<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">consumeMessage</span>(List<span style="color:#000;font-weight:bold">&lt;</span>MessageExt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>msgs,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                                    </span>ConsumeConcurrentlyContext<span style="color:#bbb"> </span>context)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(MessageExt<span style="color:#bbb"> </span>msg<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>msgs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">printf</span>(<span style="color:#d14">&#34;topic=%s tag=%s msgId=%s msgKey=%s msgBody=%s \n&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                          </span>msg.<span style="color:#008080">getTopic</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getTags</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getMsgId</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getKeys</span>(),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                          </span>JSON.<span style="color:#008080">parseObject</span>(msg.<span style="color:#008080">getBody</span>(),<span style="color:#bbb"> </span>String.<span style="color:#008080">class</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>ConsumeConcurrentlyStatus.<span style="color:#008080">CONSUME_SUCCESS</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//å¯åŠ¨æ¶ˆæ¯è€…</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é¡ºåºæ¶ˆæ¯">é¡ºåºæ¶ˆæ¯</h3>
<p>æ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯å¯ä»¥æŒ‰ç…§æ¶ˆæ¯çš„å‘é€é¡ºåºæ¥æ¶ˆè´¹ï¼ˆFIFOï¼‰ã€‚RocketMQå¯ä»¥ä¸¥æ ¼çš„ä¿è¯æ¶ˆæ¯æœ‰åºï¼Œå¯ä»¥åˆ†ä¸ºåˆ†åŒºæœ‰åºæˆ–è€…å…¨å±€æœ‰åºã€‚</p>
<p>åœ¨é»˜è®¤çš„æƒ…å†µä¸‹æ¶ˆæ¯å‘é€ä¼šé‡‡å–Round Robinè½®è¯¢æ–¹å¼æŠŠæ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„queueï¼ˆåˆ†åŒºé˜Ÿåˆ—ï¼‰ï¼Œè€Œæ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™ä»å¤šä¸ªqueueä¸Šæ‹‰å–æ¶ˆæ¯ï¼Œè¿™ç§æƒ…å†µå‘é€å’Œæ¶ˆè´¹æ˜¯ä¸èƒ½ä¿è¯é¡ºåºã€‚ä½†æ˜¯å¦‚æœæ§åˆ¶å‘é€çš„é¡ºåºæ¶ˆæ¯åªä¾æ¬¡å‘é€åˆ°åŒä¸€ä¸ªqueueä¸­ï¼Œæ¶ˆè´¹çš„æ—¶å€™åªä»è¿™ä¸ªqueueä¸Šä¾æ¬¡æ‹‰å–ï¼Œåˆ™å°±ä¿è¯äº†é¡ºåºã€‚å½“å‘é€å’Œæ¶ˆè´¹å‚ä¸çš„queueåªæœ‰ä¸€ä¸ªï¼Œåˆ™æ˜¯å…¨å±€æœ‰åºï¼›å¦‚æœå¤šä¸ªqueueå‚ä¸ï¼Œåˆ™ä¸ºåˆ†åŒºæœ‰åºï¼Œå³ç›¸å¯¹æ¯ä¸ªqueueï¼Œæ¶ˆæ¯éƒ½æ˜¯æœ‰åºçš„ã€‚</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">sendOrderMessageTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;order_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>10;<span style="color:#bbb"> </span>i<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;order_product&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;order Message &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>i));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>SendResult<span style="color:#bbb"> </span>sendResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>producer.<span style="color:#008080">send</span>(message,<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MessageQueueSelector()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>MessageQueue<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">select</span>(List<span style="color:#000;font-weight:bold">&lt;</span>MessageQueue<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>mqs,<span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span>msg,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>arg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Integer<span style="color:#bbb"> </span>argInt<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>(Integer)<span style="color:#bbb"> </span>arg;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>mqs.<span style="color:#008080">get</span>(argInt<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">%</span><span style="color:#bbb"> </span>mqs.<span style="color:#008080">size</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>},<span style="color:#bbb"> </span>101);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;sendResult = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(10);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">orderConsumerTest3</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…,æŒ‡å®šç»„å</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQPushConsumer<span style="color:#bbb"> </span>consumer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQPushConsumer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;orderConsumerGroup&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¢é˜…Topic</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">subscribe</span>(<span style="color:#d14">&#34;order_product&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// é›†ç¾¤æ¨¡å¼æ¶ˆè´¹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setMessageModel</span>(MessageModel.<span style="color:#008080">CLUSTERING</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// ä»é˜Ÿåˆ—å°¾éƒ¨æ¶ˆè´¹</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">setConsumeFromWhere</span>(ConsumeFromWhere.<span style="color:#008080">CONSUME_FROM_LAST_OFFSET</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">registerMessageListener</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MessageListenerOrderly()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>ConsumeOrderlyStatus<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">consumeMessage</span>(List<span style="color:#000;font-weight:bold">&lt;</span>MessageExt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>msgs,<span style="color:#bbb"> </span>ConsumeOrderlyContext<span style="color:#bbb"> </span>context)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(MessageExt<span style="color:#bbb"> </span>msg<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>msgs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">printf</span>(<span style="color:#d14">&#34;topic=%s tag=%s msgId=%s msgKey=%s msgBody=%s \n&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                          </span>msg.<span style="color:#008080">getTopic</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getTags</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getMsgId</span>(),<span style="color:#bbb"> </span>msg.<span style="color:#008080">getKeys</span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                          </span>JSON.<span style="color:#008080">parseObject</span>(msg.<span style="color:#008080">getBody</span>(),<span style="color:#bbb"> </span>String.<span style="color:#008080">class</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>ConsumeOrderlyStatus.<span style="color:#008080">SUCCESS</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//å¯åŠ¨æ¶ˆæ¯è€…</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å»¶æ—¶æ¶ˆæ¯">å»¶æ—¶æ¶ˆæ¯</h3>
<p>å»¶è¿Ÿæ¶ˆæ¯å¯è§ï¼ŒRocketMQæ”¯æŒå¦‚ä¸‹æ—¶é—´ç‚¹çš„å»¶è¿Ÿ<code>1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</code>ï¼Œ ç­‰çº§ä»å·¦åˆ°å³ä»1å¼€å§‹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">testDelayMessage</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DefaultMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>DefaultMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;delay_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>10;<span style="color:#bbb"> </span>i<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;delay_product&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Hello RocketMQ Delay Send Message &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>i));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// è®¾ç½®æ¶ˆæ¯å»¶è¿Ÿç­‰çº§</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>message.<span style="color:#008080">setDelayTimeLevel</span>(4);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>SendResult<span style="color:#bbb"> </span>sendResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>producer.<span style="color:#008080">send</span>(message);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;sendResult = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(10);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>apacheæ²¡æœ‰å®šæ—¶æ¶ˆæ¯çš„æ¦‚å¿µï¼Œé˜¿é‡Œäº‘æœ‰å®šæ—¶æ¶ˆæ¯çš„æ¦‚å¿µï¼šæŒ‡å®šæ—¶é—´è½¬æˆæ—¶é—´æˆ³ï¼Œè¡¨ç¤ºå®šæ—¶æ¶ˆæ¯</p>
</blockquote>
<h3 id="è¿‡æ»¤æ¶ˆæ¯æ¶ˆè´¹">è¿‡æ»¤æ¶ˆæ¯æ¶ˆè´¹</h3>
<ul>
<li>tagè¿‡æ»¤</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// åˆ©ç”¨Tagè¿›è¡Œè¿‡æ»¤ï¼Œæ¥æ”¶æ‰€æœ‰Tagæ¶ˆæ¯ä¸º *</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>consumer.<span style="color:#008080">subscribe</span>(<span style="color:#d14">&#34;TOPIC&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;TAGA || TAGB || TAGC&#34;</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>SQLè¿‡æ»¤æ¶ˆæ¯æ¶ˆè´¹</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// aå–è‡ªæ¶ˆæ¯çš„å±æ€§ï¼Œå³Message.putUserProperty(&#34;a&#34;, String.valueOf(num))</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>consumer.<span style="color:#008080">subscribe</span>(<span style="color:#d14">&#34;TopicTest&#34;</span>,<span style="color:#bbb"> </span>MessageSelector.<span style="color:#008080">bySql</span>(<span style="color:#d14">&#34;a between 0 and 3&#34;</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="äº‹åŠ¡æ¶ˆæ¯">äº‹åŠ¡æ¶ˆæ¯</h3>
<p>äº‹åŠ¡æ¶ˆæ¯åªä¿è¯å‘é€ç«¯çš„äº‹åŠ¡ï¼Œä¸ä¿è¯æ¶ˆè´¹ç«¯çš„äº‹åŠ¡ï¼Œæ¶ˆè´¹å¤±è´¥æ—¶å‘é€å¹¶ä¸ä¼šä»»åŠ¡è¡¥å¿å›æ»š</p>
<p><img src="/img/rocketmq/transaction-message.png" alt="transaction-message"></p>
<p>1ï¼‰äº‹åŠ¡æ¶ˆæ¯å‘é€åŠæäº¤</p>
<ol>
<li>å‘é€æ¶ˆæ¯ï¼ˆhalfæ¶ˆæ¯ï¼Œä¸å¯è§ï¼‰</li>
<li>æœåŠ¡ç«¯å“åº”æ¶ˆæ¯å†™å…¥ç»“æœ</li>
<li>æ ¹æ®å‘é€ç»“æœæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆå¦‚æœå†™å…¥å¤±è´¥ï¼Œæ­¤æ—¶halfæ¶ˆæ¯å¯¹ä¸šåŠ¡ä¸å¯è§ï¼Œæœ¬åœ°é€»è¾‘ä¸æ‰§è¡Œï¼‰</li>
<li>æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€æ‰§è¡ŒCommitæˆ–è€…Rollbackï¼ˆCommitæ“ä½œç”Ÿæˆæ¶ˆæ¯ç´¢å¼•ï¼Œæ¶ˆæ¯å¯¹æ¶ˆè´¹è€…å¯è§ï¼‰</li>
</ol>
<p>2ï¼‰äº‹åŠ¡è¡¥å¿</p>
<ol>
<li>å¯¹æ²¡æœ‰Commit/Rollbackçš„äº‹åŠ¡æ¶ˆæ¯ï¼ˆpendingçŠ¶æ€çš„æ¶ˆæ¯ï¼‰ï¼Œä»æœåŠ¡ç«¯å‘èµ·ä¸€æ¬¡â€œå›æŸ¥â€</li>
<li>Produceræ”¶åˆ°å›æŸ¥æ¶ˆæ¯ï¼Œæ£€æŸ¥å›æŸ¥æ¶ˆæ¯å¯¹åº”çš„æœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€</li>
<li>æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œé‡æ–°Commitæˆ–è€…Rollback</li>
</ol>
<p>3ï¼‰äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€</p>
<ol>
<li>TransactionStatus.CommitTransaction: æäº¤äº‹åŠ¡ï¼Œå®ƒå…è®¸æ¶ˆè´¹è€…æ¶ˆè´¹æ­¤æ¶ˆæ¯</li>
<li>TransactionStatus.RollbackTransaction: å›æ»šäº‹åŠ¡ï¼Œå®ƒä»£è¡¨è¯¥æ¶ˆæ¯å°†è¢«åˆ é™¤ï¼Œä¸å…è®¸è¢«æ¶ˆè´¹</li>
<li>TransactionStatus.Unknown: ä¸­é—´çŠ¶æ€ï¼Œå®ƒä»£è¡¨éœ€è¦æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ¥ç¡®å®šçŠ¶æ€</li>
</ol>
<p><strong>å‘é€äº‹åŠ¡æ¶ˆæ¯</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">sendTransactionMessageTest</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TransactionMQProducer<span style="color:#bbb"> </span>producer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>TransactionMQProducer(<span style="color:#d14">&#34;rocketmq-cluster&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;transaction_message_producer_group&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è®¾ç½®NameServerçš„åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setNamesrvAddr</span>(<span style="color:#d14">&#34;192.168.22.162:9876;192.168.22.163:9876&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">setTransactionListener</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>OrderTransactionListenerImpl());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¯åŠ¨producer</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>10;<span style="color:#bbb"> </span>i<span style="color:#000;font-weight:bold">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Message<span style="color:#bbb"> </span>message<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Message(<span style="color:#d14">&#34;transaction_product&#34;</span>,<span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONBytes</span>(<span style="color:#d14">&#34;Order  Transaction Message&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// å‘é€æ¶ˆæ¯</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>SendResult<span style="color:#bbb"> </span>sendResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>producer.<span style="color:#008080">sendMessageInTransaction</span>(message,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;sendResult = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TimeUnit.<span style="color:#008080">SECONDS</span>.<span style="color:#008080">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>producer.<span style="color:#008080">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>äº‹åŠ¡æ¶ˆæ¯çš„Listener</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderTransactionListenerImpl</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>TransactionListener<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// è¿™é‡Œä¸åº”è¯¥æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåº”è¯¥ä½¿ç”¨redisç­‰</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">static</span><span style="color:#bbb"> </span>ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;</span>String,<span style="color:#bbb"> </span>Integer<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>countCheckNumMap<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// æœ€å¤§æ£€æŸ¥æ¬¡æ•°</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">int</span><span style="color:#bbb"> </span>MAX_CHECK<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>5;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>LocalTransactionState<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">executeLocalTransaction</span>(Message<span style="color:#bbb"> </span>msg,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>arg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>msg.<span style="color:#008080">getTransactionId</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#998;font-style:italic">//æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶ä¿å­˜TransactionIdåˆ°ä¸€å¼ è¡¨ä¸­&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#998;font-style:italic">// æ¨¡æ‹Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­å‘é€å¼‚å¸¸</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#458;font-weight:bold">boolean</span><span style="color:#bbb"> </span>exeException<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>RandomUtil.<span style="color:#008080">randomBoolean</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(exeException)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>msg.<span style="color:#008080">getTransactionId</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span><span style="color:#d14">&#34; æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException(<span style="color:#d14">&#34;æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#998;font-style:italic">// æ¨¡æ‹Ÿæ‰§è¡Œè¿‡ç¨‹å®•æœºï¼Œå›æ»š</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#458;font-weight:bold">boolean</span><span style="color:#bbb"> </span>unknowException<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>RandomUtil.<span style="color:#008080">randomBoolean</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(unknowException)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>msg.<span style="color:#008080">getTransactionId</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span><span style="color:#d14">&#34; æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸­æ–­æ‰§è¡Œ&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>LocalTransactionState.<span style="color:#008080">UNKNOW</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Throwable<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>LocalTransactionState.<span style="color:#008080">ROLLBACK_MESSAGE</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>msg.<span style="color:#008080">getTransactionId</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span><span style="color:#d14">&#34; æäº¤&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>LocalTransactionState.<span style="color:#008080">COMMIT_MESSAGE</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>LocalTransactionState<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">checkLocalTransaction</span>(MessageExt<span style="color:#bbb"> </span>msg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;checkLocalTransaction transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>msg.<span style="color:#008080">getTransactionId</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰æ­¤transactionIdï¼Œæœ‰è¿”å›commitï¼Œæ²¡æœ‰è¿”å›unknowï¼Œç¤ºä¾‹ä»£ç ç”¨éšæœºäº†</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#458;font-weight:bold">boolean</span><span style="color:#bbb"> </span>findTransaction<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>RandomUtil.<span style="color:#008080">randomBoolean</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(findTransaction)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;æäº¤ transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>msg.<span style="color:#008080">getTransactionId</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>LocalTransactionState.<span style="color:#008080">COMMIT_MESSAGE</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>rollbackOrUnknow(msg.<span style="color:#008080">getTransactionId</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>LocalTransactionState<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">rollbackOrUnknow</span>(String<span style="color:#bbb"> </span>transactionId)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Integer<span style="color:#bbb"> </span>countCheckNum<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>countCheckNumMap.<span style="color:#008080">get</span>(transactionId);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(countCheckNum<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&amp;&amp;</span><span style="color:#bbb"> </span>countCheckNum<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>MAX_CHECK)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;å›æ»š transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>transactionId);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>LocalTransactionState.<span style="color:#008080">ROLLBACK_MESSAGE</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(countCheckNum<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">==</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>countCheckNumMap.<span style="color:#008080">put</span>(transactionId,<span style="color:#bbb"> </span>1);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;æœªçŸ¥ transactionId = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>transactionId);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>LocalTransactionState.<span style="color:#008080">UNKNOW</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>äº‹åŠ¡æ¶ˆæ¯æ³¨æ„ç‚¹</strong></p>
<ul>
<li>
<p>äº‹åŠ¡æ¶ˆæ¯ä¸æ”¯æŒå»¶æ—¶æ¶ˆæ¯å’Œæ‰¹é‡æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>ä¸ºäº†é¿å…å•ä¸ªæ¶ˆæ¯è¢«æ£€æŸ¥å¤ªå¤šæ¬¡è€Œå¯¼è‡´åŠé˜Ÿåˆ—æ¶ˆæ¯ç´¯ç§¯ï¼Œé»˜è®¤å•ä¸ªæ¶ˆæ¯çš„æ£€æŸ¥æ¬¡æ•°é™åˆ¶ä¸º15æ¬¡ï¼Œå¯ä»¥ä¿®æ”¹Brokeré…ç½®æ–‡ä»¶çš„ <code>transactionCheckMax</code>å‚æ•°æ¥ä¿®æ”¹æ­¤é™åˆ¶ã€‚å¦‚æœå·²ç»æ£€æŸ¥æŸæ¡æ¶ˆæ¯è¶…è¿‡ N æ¬¡çš„è¯ï¼ˆN =<code>transactionCheckMax</code> ï¼‰ åˆ™Brokerå°†ä¸¢å¼ƒæ­¤æ¶ˆæ¯ï¼Œå¹¶åœ¨é»˜è®¤æƒ…å†µä¸‹åŒæ—¶æ‰“å°é”™è¯¯æ—¥å¿—ã€‚å¯ä»¥é‡å†™<code>AbstractTransactionCheckListener</code>ä¿®æ”¹è¿™ä¸ªè¡Œä¸º</p>
</li>
<li>
<p>äº‹åŠ¡æ¶ˆæ¯å°†åœ¨Brokeré…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°<code>transactionMsgTimeout</code>è¿™æ ·çš„ç‰¹å®šæ—¶é—´é•¿åº¦ä¹‹åè¢«æ£€æŸ¥ã€‚å½“å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶ï¼Œç”¨æˆ·è¿˜å¯ä»¥é€šè¿‡è®¾ç½®ç”¨æˆ·å±æ€§ <code>CHECK_IMMUNITY_TIME_IN_SECONDS</code>æ¥æ”¹å˜è¿™ä¸ªé™åˆ¶ï¼Œé»˜è®¤ä¸º1åˆ†é’Ÿ</p>
</li>
<li>
<p>äº‹åŠ¡æ€§æ¶ˆæ¯å¯èƒ½ä¸æ­¢ä¸€æ¬¡è¢«æ£€æŸ¥æˆ–æ¶ˆè´¹</p>
</li>
<li>
<p>äº‹åŠ¡æ¶ˆæ¯çš„ç”Ÿäº§è€…IDä¸èƒ½ä¸å…¶ä»–ç±»å‹æ¶ˆæ¯çš„ç”Ÿäº§è€…IDå…±äº«ã€‚äº‹åŠ¡æ¶ˆæ¯å…è®¸åå‘æŸ¥è¯¢ã€MQæœåŠ¡å™¨èƒ½é€šè¿‡å®ƒä»¬çš„ç”Ÿäº§è€…IDæŸ¥è¯¢åˆ°æ¶ˆè´¹è€…</p>
</li>
</ul>
<h2 id="å››springbooté›†æˆrocketmq">å››ã€SpringBooté›†æˆRocketMQ</h2>
<p>å‰ç½®æ¡ä»¶POMå¼•å…¥ä¾èµ–</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;groupId&gt;</span>org.apache.rocketmq<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;artifactId&gt;</span>rocketmq-spring-boot-starter<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;version&gt;</span>[version]<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½®<code>application.properties</code>æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nameServeræœåŠ¡å™¨åœ°å€</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.name-server</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">192.168.22.162:9876;192.168.22.163:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘é€è€…ç»„åç§°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.group</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">myApp-producer-group</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘é€æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.send-message-timeout</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‹ç¼©æ¶ˆæ¯å‘é€çš„é˜ˆå€¼ï¼Œå•ä½å­—èŠ‚</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.compress-message-body-threshold</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">4096</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ¶ˆæ¯ä½“å…è®¸çš„æœ€å¤§å¤§å°</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.max-message-size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">4194304</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å¼‚æ­¥å‘é€æ¶ˆæ¯å¤±è´¥çš„é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤2æ¬¡</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.retry-times-when-send-async-failed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">0</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å‘é€æ¶ˆæ¯ç»™Brokeræ—¶ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•å¦å¤–ä¸€å°Brokerï¼Œé»˜è®¤ä¸ºfalse</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.retry-next-server</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">false</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åŒæ­¥å‘é€æ¶ˆæ¯å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤2æ¬¡</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.retry-times-when-send-failed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å¼€å¯æ¶ˆæ¯è½¨è¿¹åŠŸèƒ½ï¼Œé»˜è®¤ä¸ºfalseå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.enable-msg-trace</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ˜¯å¦å¼€å¯æ¶ˆæ¯è½¨è¿¹åŠŸèƒ½ï¼Œé»˜è®¤ä¸ºfalseå…³é—­</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.consumer.enable-msg-trace</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># è‡ªå®šä¹‰æ¶ˆæ¯è½¨è¿¹çš„Topicï¼Œé»˜è®¤ä¸º RMQ_SYS_TRACE_TOPIC</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">rocketmq.producer.customized-trace-topic</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">RMQ_SYS_TRACE_TOPIC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯</h3>
<ul>
<li>
<p>åŒæ­¥å‘é€æ¶ˆæ¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// ç¬¬ä¸€ç§æ–¹å¼</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>rocketMQTemplate.<span style="color:#008080">convertAndSend</span>(<span style="color:#d14">&#34;userTopic:tagA&#34;</span>,<span style="color:#bbb"> </span>user);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// ç¬¬äºŒç§æ–¹å¼</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>rocketMQTemplate.<span style="color:#008080">send</span>(<span style="color:#d14">&#34;userTopic:tagB&#34;</span>,<span style="color:#bbb"> </span>MessageBuilder.<span style="color:#008080">withPayload</span>(user).<span style="color:#008080">build</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>å¼‚æ­¥å‘é€æ¶ˆæ¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>rocketMQTemplate.<span style="color:#008080">asyncSend</span>(<span style="color:#d14">&#34;userTopic:tagC&#34;</span>,<span style="color:#bbb"> </span>user,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>SendCallback()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onSuccess</span>(SendResult<span style="color:#bbb"> </span>sendResult)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;async onSuccess SendResult=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(sendResult));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onException</span>(Throwable<span style="color:#bbb"> </span>throwable)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;async onException Throwable=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(throwable));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>});<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>å‘é€é¡ºåºæ¶ˆæ¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºä»¥å“ªä¸ªå­—æ®µä½œä¸ºhashkeyå‘é€åˆ°å¯¹åº”é˜Ÿåˆ—</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>rocketMQTemplate.<span style="color:#008080">syncSendOrderly</span>(<span style="color:#d14">&#34;orderly_user_topic&#34;</span>,<span style="color:#bbb"> </span>user,<span style="color:#bbb"> </span><span style="color:#d14">&#34;name&#34;</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>å‘é€äº‹åŠ¡æ¶ˆæ¯[ä»¥ä¸‹é‡‡ç”¨åˆ†ç¦»rocketTemplateæ–¹å¼]</p>
<ul>
<li>åˆ›å»ºæ–°çš„ä¸“å±çš„RocketTemplate</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@AutoConfigureAfter</span>({<span style="color:#bbb"> </span>RocketMQAutoConfiguration.<span style="color:#008080">class</span>})<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@AutoConfigureBefore</span>({<span style="color:#bbb"> </span>RocketMQTransactionConfiguration.<span style="color:#008080">class</span>})<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MqTransactionConfigure</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>ApplicationContextAware<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>PRODUCER_BEAN_NAME<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;defaultMQProducer&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>CONSUMER_BEAN_NAME<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;defaultLitePullConsumer&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>ApplicationContext<span style="color:#bbb"> </span>applicationContext;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">setApplicationContext</span>(ApplicationContext<span style="color:#bbb"> </span>applicationContext)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>BeansException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">this</span>.<span style="color:#008080">applicationContext</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>applicationContext;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Bean</span>(name<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;userTransactionRocketMqTemplate&#34;</span>,<span style="color:#bbb"> </span>destroyMethod<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;destroy&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>RocketMQTemplate<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">userTransactionRocketMqTemplate</span>(RocketMQMessageConverter<span style="color:#bbb"> </span>rocketMqMessageConverter)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>RocketMQTemplate<span style="color:#bbb"> </span>userTransactionRocketMqTemplate<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>RocketMQTemplate(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">afterPropertiesSet</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">return</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(applicationContext.<span style="color:#008080">containsBean</span>(PRODUCER_BEAN_NAME))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>userTransactionRocketMqTemplate.<span style="color:#008080">setProducer</span>((DefaultMQProducer)<span style="color:#bbb"> </span>applicationContext.<span style="color:#008080">getBean</span>(PRODUCER_BEAN_NAME));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(applicationContext.<span style="color:#008080">containsBean</span>(CONSUMER_BEAN_NAME))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>userTransactionRocketMqTemplate.<span style="color:#008080">setConsumer</span>((DefaultLitePullConsumer)<span style="color:#bbb"> </span>applicationContext.<span style="color:#008080">getBean</span>(CONSUMER_BEAN_NAME));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>userTransactionRocketMqTemplate.<span style="color:#008080">setMessageConverter</span>(rocketMqMessageConverter.<span style="color:#008080">getMessageConverter</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>userTransactionRocketMqTemplate;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>äº‹åŠ¡æ‰§è¡ŒListener</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@RocketMQTransactionListener</span>(corePoolSize<span style="color:#000;font-weight:bold">=</span>5,<span style="color:#bbb"> </span>maximumPoolSize<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>20,<span style="color:#bbb"> </span>rocketMQTemplateBeanName<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;userTransactionRocketMqTemplate&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserTransactionListener</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>RocketMQLocalTransactionListener<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>RocketMQLocalTransactionState<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">executeLocalTransaction</span>(Message<span style="color:#bbb"> </span>msg,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>arg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;executeLocalTransaction&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>RocketMQLocalTransactionState.<span style="color:#008080">COMMIT</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>RocketMQLocalTransactionState<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">checkLocalTransaction</span>(Message<span style="color:#bbb"> </span>msg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;checkLocalTransaction&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>RocketMQLocalTransactionState.<span style="color:#008080">COMMIT</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å‘é€äº‹åŠ¡æ¶ˆæ¯</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>TransactionSendResult<span style="color:#bbb"> </span>sendResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>userTransactionRocketMqTemplate.<span style="color:#008080">sendMessageInTransaction</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#d14">&#34;test_transaction&#34;</span>,<span style="color:#bbb"> </span>MessageBuilder.<span style="color:#008080">withPayload</span>(user).<span style="color:#008080">build</span>(),<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="æ¶ˆè´¹æ¶ˆæ¯">æ¶ˆè´¹æ¶ˆæ¯</h3>
<ul>
<li>
<p>åªéœ€è¦æ¶ˆæ¯çš„æœ‰æ•ˆè´Ÿè½½</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@RocketMQMessageListener</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumerGroup<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;myApp-userTopic-consumer&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>topic<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;userTopic&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>selectorExpression<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>messageModel<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>MessageModel.<span style="color:#008080">CLUSTERING</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserConsumer</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>RocketMQListener<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onMessage</span>(User<span style="color:#bbb"> </span>user)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;user = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(user));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>éœ€è¦æ¶ˆæ¯æœ¬èº«çš„å±æ€§</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@RocketMQMessageListener</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>topic<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;userTopic&#34;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>selectorExpression<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;tagB||tagC&#34;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumerGroup<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;myApp-userTopic-ext-consumer&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserMessageExtConsumer</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>RocketMQListener<span style="color:#000;font-weight:bold">&lt;</span>MessageExt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onMessage</span>(MessageExt<span style="color:#bbb"> </span>message)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;topic=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getTopic</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;tags=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getTags</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;msgId=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getMsgId</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;msgKey=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getKeys</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;body=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">parseObject</span>(message.<span style="color:#008080">getBody</span>(),<span style="color:#bbb"> </span>User.<span style="color:#008080">class</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;é‡è¯•æ¬¡æ•°=&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>message.<span style="color:#008080">getReconsumeTimes</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>æ¶ˆè´¹é¡ºåºæ¶ˆæ¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@RocketMQMessageListener</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumerGroup<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;myApp-userTopic-orderly-consumer&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>topic<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;orderly_user_topic&#34;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>selectorExpression<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>consumeMode<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>ConsumeMode.<span style="color:#008080">ORDERLY</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderlyUserConsumer</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">implements</span><span style="color:#bbb"> </span>RocketMQListener<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">onMessage</span>(User<span style="color:#bbb"> </span>user)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(<span style="color:#d14">&#34;orderly user = &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>JSON.<span style="color:#008080">toJSONString</span>(user));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="äº”é«˜çº§åŠŸèƒ½">äº”ã€é«˜çº§åŠŸèƒ½</h2>
<h3 id="æ¶ˆæ¯å­˜å‚¨">æ¶ˆæ¯å­˜å‚¨</h3>
<p>RocketMQä½¿ç”¨æ–‡ä»¶é¡ºåºå­˜å‚¨å’Œé›¶æ‹·è´çš„æ–¹æ³•å­˜å‚¨æ•°æ®ï¼Œç›®å‰çš„é«˜æ€§èƒ½ç£ç›˜ï¼Œé¡ºåºå†™é€Ÿåº¦å¯ä»¥è¾¾åˆ°600MB/sï¼Œè€Œéšæœºå†™çš„é€Ÿåº¦åªæœ‰å¤§æ¦‚100KB/sã€‚</p>
<p><img src="/img/rocketmq/message-store.png" alt="message-store"></p>
<p>RocketMQæ¶ˆæ¯çš„å­˜å‚¨æ˜¯ç”±ConsumeQueueå’ŒCommitLogé…åˆå®Œæˆ çš„ï¼Œæ¶ˆæ¯çœŸæ­£çš„ç‰©ç†å­˜å‚¨æ–‡ä»¶æ˜¯CommitLogï¼ŒConsumeQueueæ˜¯æ¶ˆæ¯çš„é€»è¾‘é˜Ÿåˆ—ï¼Œç±»ä¼¼æ•°æ®åº“çš„ç´¢å¼•æ–‡ä»¶ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘ç‰©ç†å­˜å‚¨çš„åœ°å€ã€‚æ¯ä¸ªTopicä¸‹çš„æ¯ä¸ªMessage Queueéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ConsumeQueueæ–‡ä»¶ã€‚</p>
<p>æ¶ˆæ¯åœ¨é€šè¿‡Producerå†™å…¥RocketMQçš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§å†™ç£ç›˜æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜</p>
<ul>
<li>
<p>åŒæ­¥åˆ·ç›˜</p>
<p>åœ¨è¿”å›å†™æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¶ˆæ¯å·²ç»è¢«å†™å…¥ç£ç›˜ã€‚å…·ä½“æµç¨‹æ˜¯ï¼Œæ¶ˆæ¯å†™å…¥å†…å­˜çš„PAGECACHEåï¼Œç«‹åˆ»é€šçŸ¥åˆ·ç›˜çº¿ç¨‹åˆ·ç›˜ï¼Œ ç„¶åç­‰å¾…åˆ·ç›˜å®Œæˆï¼Œåˆ·ç›˜çº¿ç¨‹æ‰§è¡Œå®Œæˆåå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¿”å›æ¶ˆæ¯å†™ æˆåŠŸçš„çŠ¶æ€ã€‚</p>
</li>
<li>
<p>å¼‚æ­¥åˆ·ç›˜</p>
<p>åœ¨è¿”å›å†™æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¶ˆæ¯å¯èƒ½åªæ˜¯è¢«å†™å…¥äº†å†…å­˜çš„PAGECACHEã€‚å½“å†…å­˜é‡Œçš„æ¶ˆæ¯é‡ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œç»Ÿä¸€è§¦å‘å†™ç£ç›˜åŠ¨ä½œï¼Œå¿«é€Ÿå†™å…¥ã€‚</p>
</li>
</ul>
<p>åŒæ­¥åˆ·ç›˜è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œéƒ½æ˜¯é€šè¿‡Brokeré…ç½®æ–‡ä»¶é‡Œçš„flushDiskTypeå‚æ•°è®¾ç½®çš„ï¼Œè¿™ä¸ªå‚æ•°è¢«é…ç½®æˆSYNC_FLUSHã€ASYNC_FLUSHä¸­çš„ ä¸€ä¸ª</p>
<h3 id="é«˜å¯ç”¨æ€§æœºåˆ¶">é«˜å¯ç”¨æ€§æœºåˆ¶</h3>
<p><strong>æ¶ˆæ¯æ¶ˆè´¹é«˜å¯ç”¨</strong></p>
<p>åœ¨Consumerçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸éœ€è¦è®¾ç½®æ˜¯ä»Masterè¯»è¿˜æ˜¯ä»Slaveè¯»ã€‚å½“Masterä¸å¯ç”¨æˆ–è€…ç¹å¿™çš„æ—¶å€™ï¼ŒConsumerä¼šè¢«è‡ªåŠ¨åˆ‡æ¢åˆ°ä»Slaveè¯»ã€‚æœ‰äº†è‡ªåŠ¨åˆ‡æ¢Consumerè¿™ç§æœºåˆ¶ï¼Œå½“ä¸€ä¸ªMasterè§’è‰²çš„æœºå™¨å‡ºç°æ•…éšœåï¼ŒConsumerä»ç„¶å¯ä»¥ä»Slaveè¯»å–æ¶ˆæ¯ï¼Œä¸å½±å“Consumerç¨‹åºã€‚è¿™å°±è¾¾åˆ°äº†æ¶ˆè´¹ç«¯çš„é«˜å¯ç”¨æ€§ã€‚</p>
<p><strong>æ¶ˆæ¯å‘é€é«˜å¯ç”¨</strong></p>
<p>åœ¨åˆ›å»ºTopicçš„æ—¶å€™ï¼ŒæŠŠTopicçš„å¤šä¸ªMessage Queueåˆ›å»ºåœ¨å¤šä¸ªBrokerç»„ä¸Šï¼ˆç›¸åŒBrokeråç§°ï¼Œä¸åŒbrokerIdçš„æœºå™¨ç»„æˆä¸€ä¸ªBrokerç»„ï¼‰ï¼Œè¿™æ ·å½“ä¸€ä¸ªBrokerç»„çš„Masterä¸å¯ç”¨åï¼Œå…¶ä»–ç»„çš„Masterä»ç„¶å¯ç”¨ï¼ŒProducerä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯ã€‚ç›®å‰è¿˜ä¸æ”¯æŒSlaveè‡ªåŠ¨è½¬æˆMasterï¼Œå¦‚æœæœºå™¨èµ„æºä¸è¶³éœ€è¦æŠŠSlaveè½¬æˆMasterï¼Œåˆ™è¦æ‰‹åŠ¨åœæ­¢Slaveè§’è‰²çš„Brokerï¼Œæ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨Brokerã€‚</p>
<p><strong>æ¶ˆæ¯ä¸»ä»å¤åˆ¶</strong></p>
<p>å¦‚æœä¸€ä¸ªBrokerç»„æœ‰Masterå’ŒSlaveï¼Œæ¶ˆæ¯éœ€è¦ä»Masterå¤åˆ¶åˆ°Slave ä¸Šï¼Œæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å¤åˆ¶æ–¹å¼ã€‚</p>
<ul>
<li>
<p>åŒæ­¥å¤åˆ¶</p>
<p>åŒæ­¥å¤åˆ¶æ–¹å¼æ˜¯ç­‰Masterå’ŒSlaveå‡å†™æˆåŠŸåæ‰åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€åœ¨åŒæ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼Œå¦‚æœMasterå‡ºæ•…éšœï¼Œ Slaveä¸Šæœ‰å…¨éƒ¨çš„å¤‡ä»½æ•°æ®ï¼Œå®¹æ˜“æ¢å¤ï¼Œä½†æ˜¯åŒæ­¥å¤åˆ¶ä¼šå¢å¤§æ•°æ®å†™å…¥å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿååé‡</p>
</li>
<li>
<p>å¼‚æ­¥å¤åˆ¶</p>
<p>å¼‚æ­¥å¤åˆ¶æ–¹å¼æ˜¯åªè¦Masterå†™æˆåŠŸå³å¯åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ã€‚åœ¨å¼‚æ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼Œç³»ç»Ÿæ‹¥æœ‰è¾ƒä½çš„å»¶è¿Ÿå’Œè¾ƒé«˜çš„ååé‡ï¼Œä½†æ˜¯å¦‚æœMasterå‡ºäº†æ•…éšœï¼Œæœ‰äº›æ•°æ®å› ä¸ºæ²¡æœ‰è¢«å†™å…¥Slaveï¼Œæœ‰å¯èƒ½ä¼šä¸¢å¤±</p>
</li>
</ul>
<p>é…ç½®ï¼šåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶æ˜¯é€šè¿‡Brokeré…ç½®æ–‡ä»¶é‡Œçš„brokerRoleå‚æ•°è¿›è¡Œè®¾ç½®çš„ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è¢«è®¾ç½®æˆASYNC_MASTERã€ SYNC_MASTERã€SLAVEä¸­çš„ä¸€ä¸ª</p>
<blockquote>
<p>å®é™…åº”ç”¨ä¸­è¦ç»“åˆä¸šåŠ¡åœºæ™¯ï¼Œåˆç†è®¾ç½®åˆ·ç›˜æ–¹å¼å’Œä¸»ä»å¤åˆ¶æ–¹å¼ï¼Œ å°¤å…¶æ˜¯SYNC_FLUSHæ–¹å¼ï¼Œç”±äºé¢‘ç¹åœ°è§¦å‘ç£ç›˜å†™åŠ¨ä½œï¼Œä¼šæ˜æ˜¾é™ä½æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåº”è¯¥æŠŠMasterçš„Saveé…ç½®æˆASYNC_FLUSHçš„åˆ·ç›˜æ–¹å¼ï¼Œä¸»ä»ä¹‹é—´é…ç½®æˆSYNC_MASTERçš„å¤åˆ¶æ–¹å¼ï¼Œè¿™æ ·å³ä½¿æœ‰ä¸€å°æœºå™¨å‡ºæ•…éšœï¼Œä»ç„¶èƒ½ä¿è¯æ•°æ®ä¸ä¸¢ï¼Œæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
</blockquote>
<h3 id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</h3>
<p><strong>Producerè´Ÿè½½å‡è¡¡</strong></p>
<p>Producerç«¯ï¼Œæ¯ä¸ªå®ä¾‹åœ¨å‘æ¶ˆæ¯çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šè½®è¯¢æ‰€æœ‰çš„message queueå‘é€ï¼Œä»¥è¾¾åˆ°è®©æ¶ˆæ¯å¹³å‡è½åœ¨ä¸åŒçš„queueä¸Šã€‚è€Œç”±äºqueueå¯ä»¥æ•£è½åœ¨ä¸åŒçš„brokerï¼Œæ‰€ä»¥æ¶ˆæ¯å°±å‘é€åˆ°ä¸åŒçš„brokerä¸‹</p>
<p><img src="/img/rocketmq/Producer-loadbalance.png" alt="Producerè´Ÿè½½å‡è¡¡"></p>
<hr>
<p><strong>Consumerè´Ÿè½½å‡è¡¡</strong></p>
<ul>
<li>
<p>é›†ç¾¤æ¨¡å¼</p>
<p>åœ¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¯æ¡æ¶ˆæ¯åªéœ€è¦æŠ•é€’åˆ°è®¢é˜…è¿™ä¸ªtopicçš„Consumer Groupä¸‹çš„ä¸€ä¸ªå®ä¾‹å³å¯ã€‚RocketMQé‡‡ç”¨ä¸»åŠ¨æ‹‰å–çš„æ–¹å¼æ‹‰å–å¹¶æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨æ‹‰å–çš„æ—¶å€™éœ€è¦æ˜ç¡®æŒ‡å®šæ‹‰å–å“ªä¸€æ¡message queueã€‚è€Œæ¯å½“å®ä¾‹çš„æ•°é‡æœ‰å˜æ›´ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡æ‰€æœ‰å®ä¾‹çš„è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™ä¼šæŒ‰ç…§queueçš„æ•°é‡å’Œå®ä¾‹çš„æ•°é‡å¹³å‡</p>
</li>
</ul>
<p>åˆ†é…queueç»™æ¯ä¸ªå®ä¾‹ã€‚æœ‰å¦‚ä¸‹åˆ†é…ç­–ç•¥</p>
<table>
<thead>
<tr>
<th>ç­–ç•¥åç§°</th>
<th>ç­–ç•¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¹³å‡åˆ†é…ç­–ç•¥ï¼ˆé»˜è®¤ï¼‰</td>
<td>AllocateMessageQueueAveragely</td>
</tr>
<tr>
<td>ç¯å½¢åˆ†é…ç­–ç•¥</td>
<td>AllocateMessageQueueAveragelyByCircle</td>
</tr>
<tr>
<td>æ‰‹åŠ¨é…ç½®åˆ†é…ç­–ç•¥</td>
<td>AllocateMessageQueueByConfig</td>
</tr>
<tr>
<td>æœºæˆ¿åˆ†é…ç­–ç•¥</td>
<td>AllocateMessageQueueByMachineRoom</td>
</tr>
<tr>
<td>ä¸€è‡´æ€§å“ˆå¸Œåˆ†é…ç­–ç•¥</td>
<td>AllocateMessageQueueConsistentHash</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>å¹¿æ’­æ¨¡å¼</p>
<p>ç”±äºå¹¿æ’­æ¨¡å¼ä¸‹è¦æ±‚ä¸€æ¡æ¶ˆæ¯éœ€è¦æŠ•é€’åˆ°ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹é¢æ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰æ¶ˆæ¯è¢«åˆ†æ‘Šæ¶ˆè´¹çš„è¯´æ³•ã€‚</p>
</li>
</ul>
<h3 id="æ¶ˆæ¯é‡è¯•">æ¶ˆæ¯é‡è¯•</h3>
<p><strong>é¡ºåºæ¶ˆæ¯çš„é‡è¯•</strong></p>
<p>å¯¹äºé¡ºåºæ¶ˆæ¯ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œä¼šè‡ªåŠ¨ä¸æ–­è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼ˆæ¯æ¬¡é—´éš”æ—¶é—´ä¸º1ç§’ï¼‰ï¼Œè¿™æ—¶åº”ç”¨ä¼šå‡ºç°æ¶ˆæ¯æ¶ˆè´¹è¢«é˜»å¡çš„æƒ…å†µã€‚å› æ­¤åœ¨ä½¿ç”¨é¡ºåºæ¶ˆæ¯æ—¶ï¼ŒåŠ¡å¿…ä¿è¯åº”ç”¨èƒ½å¤ŸåŠæ—¶ç›‘æ§å¹¶å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µï¼Œé¿å…é˜»å¡ç°è±¡çš„å‘ç”Ÿã€‚</p>
<p><strong>æ— åºæ¶ˆæ¯çš„é‡è¯•</strong></p>
<p>å¯¹äºæ— åºæ¶ˆæ¯ï¼ˆæ™®é€šã€å®šæ—¶ã€å»¶æ—¶ã€äº‹åŠ¡æ¶ˆæ¯ï¼‰ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®è¿”å›çŠ¶æ€è¾¾åˆ°æ¶ˆæ¯é‡è¯•çš„ç»“æœ</p>
<p>æ¶ˆæ¯é˜Ÿåˆ— RocketMQ é»˜è®¤å…è®¸æ¯æ¡æ¶ˆæ¯æœ€å¤šé‡è¯• 16 æ¬¡ï¼Œæ¯æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç¬¬å‡ æ¬¡é‡è¯•</th>
<th style="text-align:center">ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´</th>
<th style="text-align:center">ç¬¬å‡ æ¬¡é‡è¯•</th>
<th style="text-align:center">ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">10 ç§’</td>
<td style="text-align:center">9</td>
<td style="text-align:center">7 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">30 ç§’</td>
<td style="text-align:center">10</td>
<td style="text-align:center">8 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">1 åˆ†é’Ÿ</td>
<td style="text-align:center">11</td>
<td style="text-align:center">9 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">2 åˆ†é’Ÿ</td>
<td style="text-align:center">12</td>
<td style="text-align:center">10 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">3 åˆ†é’Ÿ</td>
<td style="text-align:center">13</td>
<td style="text-align:center">20 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">4 åˆ†é’Ÿ</td>
<td style="text-align:center">14</td>
<td style="text-align:center">30 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">5 åˆ†é’Ÿ</td>
<td style="text-align:center">15</td>
<td style="text-align:center">1 å°æ—¶</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">6 åˆ†é’Ÿ</td>
<td style="text-align:center">16</td>
<td style="text-align:center">2 å°æ—¶</td>
</tr>
</tbody>
</table>
<p>å¦‚æœæ¶ˆæ¯é‡è¯•16æ¬¡åä»ç„¶å¤±è´¥ï¼Œæ¶ˆæ¯å°†ä¸å†æŠ•é€’ã€‚å¦‚æœä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°é‡è¯•æ—¶é—´é—´éš”è®¡ç®—ï¼ŒæŸæ¡æ¶ˆæ¯åœ¨ä¸€ç›´æ¶ˆè´¹å¤±è´¥çš„å‰æä¸‹ï¼Œå°†ä¼šåœ¨æ¥ä¸‹æ¥çš„4å°æ—¶46åˆ†é’Ÿä¹‹å†…è¿›è¡Œ16æ¬¡é‡è¯•ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´èŒƒå›´æ¶ˆæ¯å°†ä¸å†é‡è¯•æŠ•é€’ã€‚å¯é€šè¿‡<code>Message.getReconsumeTimes()</code>è·å–å½“å‰é‡è¯•æ¬¡æ•°ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong> ä¸€æ¡æ¶ˆæ¯æ— è®ºé‡è¯•å¤šå°‘æ¬¡ï¼Œè¿™äº›é‡è¯•æ¶ˆæ¯çš„ Message IDä¸ä¼šæ”¹å˜ã€‚</p>
<blockquote>
<p>å¹¿æ’­æ–¹å¼ä¸æä¾›å¤±è´¥é‡è¯•ç‰¹æ€§ï¼Œå³æ¶ˆè´¹å¤±è´¥åï¼Œå¤±è´¥æ¶ˆæ¯ä¸å†é‡è¯•ï¼Œç»§ç»­æ¶ˆè´¹æ–°çš„æ¶ˆæ¯</p>
</blockquote>
<h3 id="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</h3>
<p>å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼ŒRocketMQä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ã€‚è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚æ­¤æ—¶ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„ç‰¹æ®Šé˜Ÿåˆ—ä¸­ã€‚</p>
<p>åœ¨RocketMQä¸­ï¼Œè¿™ç§æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰</p>
<p><strong>æ­»ä¿¡é˜Ÿåˆ—çš„ç‰¹ç‚¹</strong></p>
<ul>
<li>
<p>ä¸ä¼šå†è¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹ã€‚</p>
</li>
<li>
<p>æœ‰æ•ˆæœŸä¸æ­£å¸¸æ¶ˆæ¯ç›¸åŒï¼Œå‡ä¸º 3 å¤©ï¼Œ3 å¤©åä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚å› æ­¤ï¼Œè¯·åœ¨æ­»ä¿¡æ¶ˆæ¯äº§ç”Ÿåçš„ 3 å¤©å†…åŠæ—¶å¤„ç†ã€‚</p>
</li>
<li>
<p>ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªGroup IDï¼Œè€Œä¸æ˜¯å¯¹åº”å•ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚</p>
</li>
<li>
<p>å¦‚æœä¸€ä¸ªGroup IDæœªäº§ç”Ÿæ­»ä¿¡æ¶ˆæ¯ï¼Œä¸ä¼šä¸ºå…¶åˆ›å»ºç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
</li>
<li>
<p>ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—åŒ…å«äº†å¯¹åº”Group IDäº§ç”Ÿçš„æ‰€æœ‰æ­»ä¿¡æ¶ˆæ¯ï¼Œä¸è®ºè¯¥æ¶ˆæ¯å±äºå“ªä¸ªTopicã€‚</p>
</li>
</ul>
<h3 id="æ¶ˆè´¹å¹‚ç­‰">æ¶ˆè´¹å¹‚ç­‰</h3>
<p>åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æœ‰å¯èƒ½ä¼šå‡ºç°é‡å¤æŠ•é€’ï¼Œæˆ–è€…æ¶ˆè´¹å¤±è´¥ä¼šè¿›è¡Œé‡æ–°æ¶ˆè´¹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹åº”ç”¨éƒ½æ˜¯å…è®¸æ¶ˆæ¯é‡å¤æŠ•é€’å’Œæ¶ˆè´¹çš„ï¼Œæ‰€ä»¥è¦åœ¨æ¶ˆè´¹ç«¯åšå¹‚ç­‰ã€‚</p>
<p>å› ä¸º<span style="color:red">Message IDæœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰</span>ï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥<code>Message ID</code>ä½œä¸ºå¤„ç†ä¾æ®ã€‚ æœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯<code>Message Key</code>è¿›è¡Œè®¾ç½®ã€‚<code>Message Key</code>åšå¹‚ç­‰å¯ä»¥ä½¿ç”¨Redisã€æˆ–è€…Etcdçš„æ–¹å¼å­˜å‚¨</p>

    </div>

    

    <div class="container-comment-giscus">
        <script src="https://giscus.app/client.js"
        data-repo="loveminimal/comment"
        data-repo-id="R_kgDOJNJQ8g"
        data-category="General"
        data-category-id="DIC_kwDOJNJQ8s4CYl0m"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="noborder_light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
        </script>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    

    <div class="beian">
        
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41092802000242">
            

        </a>

        
        <a href="//beian.miit.gov.cn" target="_blank">
            
            <span class="some">icp...<span>
            
        </a>
    </div>

    
    <div class="info">
        
        <a href="https://github.com/loveminimal/hugo-theme-virgo">ğŸ•Šï¸</a> 2016 - <span id="info-date"></span>
    </div>

</div></div>
        <div class="cool-after" style="
            
                background-color: rgba(255, 255, 255, 0.49); 
                backdrop-filter: saturate(100%) blur(6px);
            
            "></div>
    </body>
</html>
