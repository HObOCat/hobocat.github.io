<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="MongoDB使用详解 - https://hobocat.github.io/post/nosql/2021-01-29-mongodb/">
    <meta name="author" content="Jack - https://hobocat.github.io/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>MongoDB使用详解</title>
    
    <base target="_blank">
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    
    
    
    
    <link rel="stylesheet" href="https://hobocat.github.io/style.min.94e7ed14b48117025ebd1148adc11f7268f1ebf50d97297ac663edf1aa6f52dc.css">
    
    <script>const DARK =  false ;</script>
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div class="container-floating-box">
	<div class="box box1"></div>
	<div class="box box11"></div>
	<div class="box box12"></div>
	<div class="box box2"></div>
	<div class="box box3"></div>
	<div class="box box4"></div>
	<div class="box box5"></div>
	<div class="box box6"></div>
	<div class="box box7"></div>
	<div class="box box8"></div>
	<div class="box box9"></div>
</div>
        <div class="cool-before" style="background: url('/imgs/bg/wallhaven-6qr21l.jpg') left top/100% no-repeat fixed;"></div>
        <div id="header" class=""><div class="container-header">

    
    
    
    <div class="right">
        
        <h1 class="title">MongoDB使用详解</h1>
    
        
        
            <div id="toc">📜</div>
        
    </div>
</div>
</div>
        <div id="content">










<div class="container-main container-page ">

    

    
    
    
    <div class="rel">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        <div class="curtag-desc">
            <a href="https://hobocat.github.io/tags/nosql/"><img src="/imgs/icons/tag.svg" width="16" /> 相关文章：NoSQL <sup>3</sup></a>
        </div>

        <div class="curtag-post">
            
            
            
                <div class="curtag-post-item curtag-post-item--active">
                    <a href="https://hobocat.github.io/post/nosql/2021-01-29-mongodb/">MongoDB使用详解</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://hobocat.github.io/post/nosql/2019-03-21-redis/">Redis使用详解</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://hobocat.github.io/post/nosql/2022-09-05-redisstruct/">redis底层数据结构</a>
                </div>
                
                
        </div>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="7409" width="12" height="12">
                <path
                    d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z"
                    p-id="7410" fill="#adb5bd"></path>
            </svg>
            2021-01-29&nbsp;&nbsp;&nbsp;
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="23838" width="11" height="11">
                <path
                    d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z"
                    p-id="23839" fill="#adb5bd"></path>
            </svg>
            2024-05-15&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="33866" width="12" height="12">
                <path
                    d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z"
                    fill="#adb5bd" p-id="33867"></path>
                <path
                    d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z"
                    fill="#adb5bd" p-id="33868"></path>
            </svg>
            14828 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="32892" width="12" height="12">
                <path
                    d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z"
                    p-id="32893" fill="#adb5bd"></path>
                <path
                    d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z"
                    p-id="32894" fill="#adb5bd"></path>
            </svg>
            30 分钟</span>
        <div class="container-ctgtag">
	<div class="taxonomy">
		<div class="tag">
			
			
			<a href="/tags/nosql">NoSQL</a>
			
		</div>
	</div>
</div>
        
    </div>

    <div class="toc">
        <div class="container-page-operation">
	<div class="page-operation">
		<div><a href="/"><img src="/imgs/icons/home-2.svg" alt=""></a></div>
		<div><a href="/nav"><img src="/imgs/icons/iov-navigate-1.svg" alt=""></a></div>
		<div><a href="/wiki"><img src="/imgs/icons/wiki.svg" alt=""></a></div>
		<div><a href="/tags"><img src="/imgs/icons/treetags.svg" alt=""></a></div>
		<div id="light-dark"><a><img src="/imgs/icons/moon2.svg" alt=""></a></div>
		<div><a href="#"><img src="/imgs/icons/up2.svg" alt=""></a></div>
	</div>
</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一mongodb简介安装">一、MongoDB简介&amp;安装</a>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#单节点安装">单节点安装</a></li>
      </ul>
    </li>
    <li><a href="#二基本概念">二、基本概念</a>
      <ul>
        <li><a href="#无模式数据库">无模式数据库</a></li>
        <li><a href="#mongodb三要素">MongoDB三要素</a></li>
        <li><a href="#mongodb的数据类型">MongoDB的数据类型</a></li>
      </ul>
    </li>
    <li><a href="#三用户权限">三、用户权限</a>
      <ul>
        <li><a href="#创建用户">创建用户</a></li>
        <li><a href="#登陆用户">登陆用户</a></li>
        <li><a href="#查看用户信息">查看用户信息</a></li>
        <li><a href="#更新用户">更新用户</a></li>
        <li><a href="#修改用户密码函数">修改用户密码函数</a></li>
        <li><a href="#删除用户">删除用户</a></li>
      </ul>
    </li>
    <li><a href="#四database操作">四、Database操作</a></li>
    <li><a href="#五collection操作">五、Collection操作</a></li>
    <li><a href="#六document-操作">六、Document 操作</a>
      <ul>
        <li><a href="#新增文档">新增文档</a></li>
        <li><a href="#查询文档">查询文档</a></li>
        <li><a href="#更新文档">更新文档</a></li>
        <li><a href="#删除文档">删除文档</a></li>
      </ul>
    </li>
    <li><a href="#七内置函数">七、内置函数</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#八运算符">八、运算符</a></li>
    <li><a href="#九索引">九、索引</a>
      <ul>
        <li><a href="#创建索引">创建索引</a></li>
        <li><a href="#查看索引">查看索引</a></li>
        <li><a href="#索引类型">索引类型</a></li>
        <li><a href="#查询计划">查询计划</a></li>
      </ul>
    </li>
    <li><a href="#十集群">十、集群</a>
      <ul>
        <li><a href="#复制集replication-set">复制集（Replication Set）</a></li>
        <li><a href="#分片集群shard-cluster">分片集群（shard cluster）</a></li>
      </ul>
    </li>
    <li><a href="#十一spring-data-mongodb">十一、Spring Data Mongodb</a>
      <ul>
        <li><a href="#创建文档">创建文档</a></li>
        <li><a href="#更新文档-1">更新文档</a></li>
        <li><a href="#删除文档-1">删除文档</a></li>
        <li><a href="#查询文档-1">查询文档</a></li>
        <li><a href="#聚合操作">聚合操作</a></li>
        <li><a href="#gridfs操作">GridFS操作</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  '>
        <h2 id="一mongodb简介安装">一、MongoDB简介&amp;安装</h2>
<h3 id="简介">简介</h3>
<p>​	MongoDB是NoSQL数据库中的文档型数据库，文档型数据库与关系型最为接近。它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。MongoDB具有便捷和丰富的查询手段，高可用（主备）的特性，横向扩展（sharding）的能力，并支持多个存储引擎（wiredtiger、mmap）等优秀特性。</p>
<h3 id="单节点安装">单节点安装</h3>
<p><strong>第一步：安装依赖</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install -y make
</span></span><span style="display:flex;"><span>yum install -y gcc-c++
</span></span><span style="display:flex;"><span>yum install -y openssl
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第二步：tar包解压缩</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tar -zxvf mongodb-linux-x86_64-rhel<span style="color:#000;font-weight:bold">[</span>version<span style="color:#000;font-weight:bold">]</span>.tgz -C /opt/module/
</span></span><span style="display:flex;"><span>mv /opt/module/mongodb-linux-x86_64-rhel<span style="color:#000;font-weight:bold">[</span>version<span style="color:#000;font-weight:bold">]</span> /opt/module/mongodb
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第三步：目录</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建数据存储目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/mongodb/data
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建日志存储目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/mongodb/logs
</span></span><span style="display:flex;"><span>touch /opt/module/mongodb/logs/mongodb.log
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第四步：单节点启动</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 方式一：后台启动方式 --fork，否则是个前台进程</span>
</span></span><span style="display:flex;"><span>./mongod --dbpath<span style="color:#000;font-weight:bold">=</span>/opt/module/mongodb/data --logpath<span style="color:#000;font-weight:bold">=</span>/opt/module/mongodb/logs/mongodb.log --bind_ip_all --fork <span style="color:#000;font-weight:bold">[</span>--logappend<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 方式二：配置文件启动</span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/mongodb/conf
</span></span><span style="display:flex;"><span>vim /opt/module/mongodb/conf/mongodb.conf
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># logpath=/opt/module/mongodb/logs/mongodb.log</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># dbpath=/opt/module/mongodb/data</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># bind_ip_all=true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># fork=true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># logappend=true</span>
</span></span><span style="display:flex;"><span>./mongod -f /opt/module/mongodb/conf/mongodb.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第四步：关闭</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 方式一：kill进程</span>
</span></span><span style="display:flex;"><span>ps -aux | grep mongod
</span></span><span style="display:flex;"><span><span style="color:#0086b3">kill</span> -9 <span style="color:#000;font-weight:bold">[</span>processId<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 方式二：命令关闭，关闭时必须指定数据存放位置</span>
</span></span><span style="display:flex;"><span>./mongod --shutdown -dbpath<span style="color:#000;font-weight:bold">=</span>/opt/module/mongodb/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 方式三：进入mongo客户端，使用函数关闭</span>
</span></span><span style="display:flex;"><span>./mongo
</span></span><span style="display:flex;"><span>use admin
</span></span><span style="display:flex;"><span>db.shutdownServer<span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="二基本概念">二、基本概念</h2>
<h3 id="无模式数据库">无模式数据库</h3>
<p>​	很多NoSQL数据库有无模式的共同点。若要在关系型数据库中存储数据，首先必须定义<code>模式</code>，也就是用一种预定义结构向数据库说明要有哪些表格，表中有哪些列，每一列都存放何种类型的数据。必须先定义好模式，然后才能存放数据。</p>
<p>​	相比之下，NoSQL数据库的数据存储就比较随意。<code>键值数据库</code>可以把任何数据存放在一个键的名下。<code>文档数据库</code>实际上也如此，因为它对所存储的文档结构没有限制。在列族数据库中，任意列里面都可以随意存放数据。你可以在<code>图数据库</code>中新增边，也可以随意向节点和边中添加属性。</p>
<h3 id="mongodb三要素">MongoDB三要素</h3>
<p><strong>MongoDB三要素与传统关系型数据库概念类比</strong></p>
<table>
<thead>
<tr>
<th>传统数据库</th>
<th>MongDB</th>
<th>解释说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>table</td>
<td>collection</td>
<td>数据库表/集合</td>
</tr>
<tr>
<td>row</td>
<td>document</td>
<td>数据记录行/文档</td>
</tr>
<tr>
<td>column</td>
<td>field</td>
<td>数据字段/域</td>
</tr>
<tr>
<td>index</td>
<td>index</td>
<td>索引</td>
</tr>
<tr>
<td>table joins</td>
<td></td>
<td>表连接，MongoDB不支持</td>
</tr>
<tr>
<td>primary key</td>
<td>primary key</td>
<td>主键，MongoDB自动将_id字段设置为主键</td>
</tr>
</tbody>
</table>
<p><strong>传统数据库的row与mongoDB的document对比</strong></p>
<p>row：每一行都是一样的字段，不可添加不可减少，也就说<span style="color:red">fields的个数在定义table的时候就已经声明完成的</span></p>
<p>document： 它的每一个document都是独立的，同时也<span style="color:red">不是在创建collection的时候经声明完成的</span></p>
<h3 id="mongodb的数据类型">MongoDB的数据类型</h3>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>字符串，仅UTF-8编码合法</td>
</tr>
<tr>
<td>Integer</td>
<td>整型数值，根据服务器不同，可分为32位或64位</td>
</tr>
<tr>
<td>Boolean</td>
<td>布尔值</td>
</tr>
<tr>
<td>Double</td>
<td>双精度浮点数</td>
</tr>
<tr>
<td>Array</td>
<td>用于将数组或列表或多个值存储为一个键</td>
</tr>
<tr>
<td>Timestamp</td>
<td>时间戳</td>
</tr>
<tr>
<td>Object</td>
<td>用于内嵌文档</td>
</tr>
<tr>
<td>Null</td>
<td>用于创建空文档</td>
</tr>
<tr>
<td>Symbol</td>
<td>符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于使用了特殊符号类型的语言</td>
</tr>
<tr>
<td>Date</td>
<td>日期时间。用UNIX时间格式来存储日期</td>
</tr>
</tbody>
</table>
<h2 id="三用户权限">三、用户权限</h2>
<p>​	Mongodb作为时下最为热门的数据库，那么其安全验证也是必不可少的，否则一个没有验证的数据库暴露出去，任何人可随意操作，这将是非常危险的。我们可以通过使用为MongoDB创建用户的方式来降低风险。</p>
<table>
<thead>
<tr>
<th style="text-align:left">权限名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">read</td>
<td>允许用户读取指定数据库</td>
</tr>
<tr>
<td style="text-align:left">readWrite</td>
<td>允许用户读写指定数据库</td>
</tr>
<tr>
<td style="text-align:left">dbAdmin</td>
<td>允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile</td>
</tr>
<tr>
<td style="text-align:left">userAdmin</td>
<td>允许用户向system.users集合写入，可以在指定数据库里创建、删除和管理用户</td>
</tr>
<tr>
<td style="text-align:left">clusterAdmin</td>
<td>只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限</td>
</tr>
<tr>
<td style="text-align:left">readAnyDatabase</td>
<td>只在admin数据库中可用，赋予用户所有数据库的读权限，除系统库的集合</td>
</tr>
<tr>
<td style="text-align:left">readWriteAnyDatabase</td>
<td>只在admin数据库中可用，赋予用户所有数据库的读写权限，除系统库的集合</td>
</tr>
<tr>
<td style="text-align:left">userAdminAnyDatabase</td>
<td>只在admin数据库中可用，赋予用户所有数据库的userAdmin权限，除系统库的集合</td>
</tr>
<tr>
<td style="text-align:left">dbAdminAnyDatabase</td>
<td>只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限，除系统库的集合</td>
</tr>
<tr>
<td style="text-align:left">root</td>
<td>只在admin数据库中可用。超级账号，超级权限</td>
</tr>
</tbody>
</table>
<h3 id="创建用户">创建用户</h3>
<p>前置条件：在admin库下操作。如果配置<code>auth=true</code>启动参数则需要有权限的用户操作，否则先不配置此参数，创建完用户之后开启此参数，并重启服务。</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">语法：
db.createUser({ 
    user: &#34;&lt;name&gt;&#34;,
    pwd: &#34;&lt;cleartext password&gt;&#34;,
    customData: { &lt;any Object Data&gt; },
    roles: [
        { role: &#34;&lt;role&gt;&#34;, db: &#34;&lt;database&gt;&#34; },
        ...
    ]
});
</code></pre><ul>
<li>
<p>user：新建用户名</p>
</li>
<li>
<p>pwd：新建用户密码</p>
</li>
<li>
<p>customData：存放一些用户相关的自定义数据，该属性也可忽略</p>
</li>
<li>
<p>roles：数组类型，配置用户的权限</p>
</li>
</ul>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.createUser({user:&#39;root&#39;,pwd:&#39;root&#39;,roles:[{role:&#39;root&#39;,db:&#39;admin&#39;}]})
</code></pre><blockquote>
<p>创建用户完成之后，配置<code>auth=true</code>启动参数</p>
</blockquote>
<h3 id="登陆用户">登陆用户</h3>
<p>前置条件：在admin库下操作</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">语法：
db.auth(&#39;&lt;username&gt;&#39;, &#39;&lt;password&gt;&#39;);

示例：
db.auth(&#39;root&#39;,&#39;root&#39;);
</code></pre><h3 id="查看用户信息">查看用户信息</h3>
<p>前置条件：在admin库下操作</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">show users
db.system.users.find()
</code></pre><h3 id="更新用户">更新用户</h3>
<p>前置条件：在admin库下操作</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">语法：
db.updateUser(&#39;&lt;username&gt;&#39;, {&lt;新的用户数据对象&gt;});

示例：
db.updateUser(&#39;root&#39;, {&#39;pwd&#39;:&#39;123456&#39;, &#39;roles&#39;:[{&#39;role&#39;:&#39;root&#39;, &#39;db&#39;:&#39;admin&#39;}]});
</code></pre><h3 id="修改用户密码函数">修改用户密码函数</h3>
<p>虽然更新用户函数也可以修改用户密码，MongoDB也提供了独立修改密码的函数</p>
<p>前置条件：在admin库下操作</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">语法：
db.changeUserPassword(&#34;&lt;newUserName&gt;&#34;,&#34;&lt;newPassword&gt;&#34;)

示例：
db.changeUserPassword(&#39;root&#39;, &#39;123456&#39;);
</code></pre><h3 id="删除用户">删除用户</h3>
<p>前置条件：在admin库下操作</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">语法：
db.dropUser(&#39;&lt;userName&gt;&#39;)

示例：
db.dropUser(&#39;root&#39;);
</code></pre><h2 id="四database操作">四、Database操作</h2>
<p><strong>创建数据库</strong></p>
<p>在MongoDB中创建数据库的命令使用的是use命令。该命令有两层含义：</p>
<ol>
<li>切换到指定数据库</li>
<li>如果切换的数据库不存在，则创建该数据库</li>
</ol>
<p>如果只创建数据库未在数据库中创建集合，则此创建为逻辑创建，在内存中，但并未在生成对应目录。使用查看数据库命令是扫描磁盘目录，所以无法看到</p>
<p><strong>查看数据库</strong></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">show dbs
show databases
</code></pre><p><strong>删除数据库</strong></p>
<p>在MongoDB中使用<code>db.dropDatabase()</code>函数来删除数据库。在删除数据库之前，需要切换到需要删除的数据库，执行即可</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
use test;
db.dropDatabase();
</code></pre><h2 id="五collection操作">五、Collection操作</h2>
<p>MongoDB中的集合是一组文档的集，相当于关系型数据库中的表</p>
<p><strong>创建集合</strong></p>
<blockquote>
<p>在MongoDB中，我们也可以不用创建集合，当我们插入一些数据时，会自动创建集合</p>
</blockquote>
<p>语法格式：<code>db.createCollection(&lt;collectionName&gt;, &lt;options&gt;)</code></p>
<p>options可以是如下参数</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>capped</td>
<td>布尔</td>
<td>（可选），如果为 true，则创建固定集合，且必须指定 size 参数<br/>固定集合是指当达到最大值时，它会自动覆盖最早的文档</td>
</tr>
<tr>
<td>size</td>
<td>数值</td>
<td>（可选）为固定集合指定一个最大值（以字节计）。  如果 capped 为 true，也需要指定该字段。</td>
</tr>
<tr>
<td>max</td>
<td>数值</td>
<td>（可选）指定固定集合中包含文档的最大数量。</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.createCollection(&#39;testCollection&#39;);
db.createCollection(&#39;testCollection&#39;, {&#39;capped&#39;:true, &#39;size&#39;:2000000, &#39;max&#39;:1000});
</code></pre><p><strong>查看集合</strong></p>
<p>如果要查看已有集合，可以使用<code>show collections</code>或<code>show tables</code>命令</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">show collections;
show tables;
</code></pre><p><strong>查看集合详情</strong></p>
<p>如果要查看已有集合的详情，可以使用<code>db.&lt;collectionName&gt;.stats()</code>命令</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.testCollection.stats();
</code></pre><p><strong>删除集合</strong></p>
<p>需要先切换到需要删除集合所在的数据库，使用<code>db.&lt;collectionName&gt;.drop()</code>函数删除集合即可</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.testCollection.drop();
</code></pre><h2 id="六document-操作">六、Document 操作</h2>
<p>在MongoDB中文档是指多个键及其关联的值有序地放置在一起就是文档，其实指的就是数据。MongoDB中的文档的数据结构和JSON基本一样。所有存储在集合中的数据都是BSON格式。BSON是一种类似JSON的二进制形式的存储格式，是Binary JSON的简称。</p>
<h3 id="新增文档">新增文档</h3>
<p><strong>新增单一文档</strong></p>
<ul>
<li>
<p><code>insert</code>函数</p>
<p>语法：<code>db.&lt;collectionName&gt;.insert(document)</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.insert({name: &#39;张三&#39;, nickName: &#39;Tom&#39;, &#39;age&#39;: 18, course: [&#39;java&#39;, &#39;spring&#39;]});
</code></pre></li>
<li>
<p><code>save</code>函数</p>
<p>语法：<code>db.&lt;collectionName&gt;.save(document)</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.save({name: &#39;李四&#39;, nickName: &#39;Jack&#39;, &#39;age&#39;: 18, course: [&#39;html&#39;, &#39;js&#39;]});
</code></pre></li>
<li>
<p><code>insertOne</code>函数</p>
<p>语法：<code>db.&lt;collectionName&gt;.insertOne(document)</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.insertOne({name: &#39;王五&#39;, nickName: &#39;King&#39;, &#39;age&#39;: 20, course: [&#39;java&#39;, &#39;js&#39;]});
</code></pre></li>
</ul>
<p><strong>批量新增文档</strong></p>
<ul>
<li>
<p><code>insert</code>函数</p>
<p>语法：<code>db.&lt;collectionName&gt;.insert(documents)</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.insert([
{name: &#39;张三&#39;, nickName: &#39;Tom&#39;, &#39;age&#39;: 18, course: [&#39;java&#39;, &#39;spring&#39;]},
{name: &#39;李四&#39;, nickName: &#39;Jack&#39;, &#39;age&#39;: 18, course: [&#39;html&#39;, &#39;js&#39;]},
{name: &#39;王五&#39;, nickName: &#39;King&#39;, &#39;age&#39;: 20, course: [&#39;java&#39;, &#39;js&#39;]}
]);
</code></pre></li>
<li>
<p><code>save</code>函数</p>
<p>语法：<code>db.&lt;collectionName&gt;.save(documents)</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.save([
{name: &#39;张三&#39;, nickName: &#39;Tom&#39;, &#39;age&#39;: 18, course: [&#39;java&#39;, &#39;spring&#39;]},
{name: &#39;李四&#39;, nickName: &#39;Jack&#39;, &#39;age&#39;: 18, course: [&#39;html&#39;, &#39;js&#39;]},
{name: &#39;王五&#39;, nickName: &#39;King&#39;, &#39;age&#39;: 20, course: [&#39;java&#39;, &#39;js&#39;]}
]);
</code></pre></li>
<li>
<p><code>insertMany</code>函数</p>
<p>语法：<code>db.&lt;collectionName&gt;.save(documents)</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.insertMany([
{name: &#39;张三&#39;, nickName: &#39;Tom&#39;, &#39;age&#39;: 18, course: [&#39;java&#39;, &#39;spring&#39;]},
{name: &#39;李四&#39;, nickName: &#39;Jack&#39;, &#39;age&#39;: 18, course: [&#39;html&#39;, &#39;js&#39;]},
{name: &#39;王五&#39;, nickName: &#39;King&#39;, &#39;age&#39;: 20, course: [&#39;java&#39;, &#39;js&#39;]}
]);
</code></pre></li>
</ul>
<h3 id="查询文档">查询文档</h3>
<h4 id="基础应用">基础应用</h4>
<ul>
<li>
<p><code>findOne</code>函数用于查询集合中的一个文档</p>
<p>语法：<code>db.&lt;collectionName&gt;.findOne({&lt;query&gt;}, {&lt;projection&gt;});</code></p>
<ol>
<li>query：可选，代表查询条件。</li>
<li>projection：可选，代表查询结果的投影字段名。即查询结果需要返回哪些字段或不需要返回哪些字段。</li>
</ol>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.findOne();
db.user.findOne({name: &#39;张三&#39;});
db.user.findOne({name: &#39;张三&#39;}, {name: 1, age: 1, _id: 0});
</code></pre><blockquote>
<p>投影时</p>
<p><code>_id</code>为1的时候，其他字段必须是1</p>
<p><code>_id</code>是0的时候，其他字段可以是0</p>
<p>如果没有<code>_id</code>字段约束，多个其他字段必须同为0或同为1</p>
</blockquote>
</li>
<li>
<p>find函数用于查询集合中的若干文档</p>
<p>语法：<code>db.&lt;collectionName&gt;.find({&lt;query&gt;}, {&lt;projection&gt;});</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find();
db.user.find({name: &#39;张三&#39;});
db.user.find({name: &#39;张三&#39;}, {name: 1, age: 1, _id: 0});
</code></pre></li>
</ul>
<h4 id="单条件逻辑运算符">单条件逻辑运算符</h4>
<table>
<thead>
<tr>
<th>操作</th>
<th>格式</th>
<th>范例</th>
<th>类似DBM语句</th>
</tr>
</thead>
<tbody>
<tr>
<td>等于</td>
<td><code>{&lt;key&gt;:&lt;value&gt;</code>}或<br /><code>{&lt;key&gt;:{$eq:&lt;value&gt;}}</code></td>
<td>db.col.find({name: &ldquo;张三&rdquo;})</td>
<td>where name = &lsquo;张三&rsquo;</td>
</tr>
<tr>
<td>小于</td>
<td><code>{&lt;key&gt;:{$lt:&lt;value&gt;}}</code></td>
<td>db.col.find({age: {$lt: 20}})</td>
<td>where age &lt; 20</td>
</tr>
<tr>
<td>小于等于</td>
<td><code>{&lt;key&gt;:{$lte:&lt;value&gt;}}</code></td>
<td>db.col.find({age: {$lte: 20}})</td>
<td>where age &lt;= 20</td>
</tr>
<tr>
<td>大于</td>
<td><code>{&lt;key&gt;:{$gt:&lt;value&gt;}}</code></td>
<td>db.col.find({age: {$gt: 10}})</td>
<td>where age &gt; 10</td>
</tr>
<tr>
<td>大于等于</td>
<td><code>{&lt;key&gt;:{$gte:&lt;value&gt;}}</code></td>
<td>db.col.find({age: {$gte: 10}})</td>
<td>where age &gt;= 10</td>
</tr>
<tr>
<td>不等于</td>
<td><code>{&lt;key&gt;:{$ne:&lt;value&gt;}}</code></td>
<td>db.col.find({age: {$ne: 20}})</td>
<td>where age != 20</td>
</tr>
</tbody>
</table>
<h4 id="多条件逻辑运算符">多条件逻辑运算符</h4>
<p><strong>And条件</strong></p>
<p>MongoDB的<code>find()</code>和<code>findOne()</code>函数可以传入多个键(key)，每个键(key)以逗号隔开，即常规SQL的AND条件</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find({name: &#39;张三&#39;, age :18});
</code></pre><p><strong>Or条件</strong></p>
<p>MongoDB的OR条件语句使用了关键字<code>$or</code>，语法格式如下</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find({$or: [{name: &#39;张三&#39;}, {age :18}]});
</code></pre><h4 id="type查询">$type查询</h4>
<p>在MongoDB中根据字段的数量类型来查询数据使用<code>$type</code>操作符来实现</p>
<p>语法：<code>db.&lt;collectionName&gt;.find({&lt;attr&gt;:{$type:&lt;typeNum/typeAlias&gt;}})</code></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Number</th>
<th>Alias</th>
</tr>
</thead>
<tbody>
<tr>
<td>Double</td>
<td>1</td>
<td>“double”</td>
</tr>
<tr>
<td>String</td>
<td>2</td>
<td>“string”</td>
</tr>
<tr>
<td>Object</td>
<td>3</td>
<td>“object”</td>
</tr>
<tr>
<td>Array</td>
<td>4</td>
<td>“array”</td>
</tr>
<tr>
<td>Binary data</td>
<td>5</td>
<td>“binData”</td>
</tr>
<tr>
<td>ObjectId</td>
<td>7</td>
<td>“objectId”</td>
</tr>
<tr>
<td>Boolean</td>
<td>8</td>
<td>“bool”</td>
</tr>
<tr>
<td>Date</td>
<td>9</td>
<td>“date”</td>
</tr>
<tr>
<td>Null</td>
<td>10</td>
<td>“null”</td>
</tr>
<tr>
<td>Regular Expression</td>
<td>11</td>
<td>“regex”</td>
</tr>
<tr>
<td>JavaScript</td>
<td>13</td>
<td>“javascript”</td>
</tr>
<tr>
<td>JavaScript (with scope)</td>
<td>15</td>
<td>“javascriptWithScope”</td>
</tr>
<tr>
<td>32-bit integer</td>
<td>16</td>
<td>“int”</td>
</tr>
<tr>
<td>Timestamp</td>
<td>17</td>
<td>“timestamp”</td>
</tr>
<tr>
<td>64-bit integer</td>
<td>18</td>
<td>“long”</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find({name: {$type: &#39;string&#39;}});
db.user.find({name: {$type: 2}});
</code></pre><h4 id="正则查询">正则查询</h4>
<p>MongoDB中查询条件也可以使用正则表达式作为匹配约束</p>
<p>语法：<code>db.&lt;collectionName&gt;.find({&lt;filedName&gt;:&lt;reg&gt;/&lt;option&gt;})</code></p>
<p>option的选项有</p>
<ul>
<li>i ：不区分大小写以匹配大小写的情况</li>
<li>m：对于包含锚点的模式，将<code>\n</code>视作每行，每行都进行匹配</li>
<li>x：设置x选项后，正则表达式中的非转义的空白字符将被忽略</li>
<li>s：允许点字符（.）匹配包括换行符在内的所有字符</li>
</ul>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find({name: /^张/});
db.user.find({name: /三$/});
db.user.find({nickName: /t/i});
</code></pre><h4 id="分页查询">分页查询</h4>
<p>在MongoDB中读取指定数量的数据记录，可以使用的<code>limit</code>方法，<code>limit(&lt;num&gt;)</code>方法接受一个数字参数，该参数指定读取的记录条数</p>
<p>在MongoDB中使用<code>skip</code>方法来跳过指定数量的文档，<code>skip(&lt;num&gt;)</code>方法同样接受一个数字参数作为跳过的文档条数</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find().skip(5).limit(5);
</code></pre><h4 id="排序">排序</h4>
<p>在 MongoDB中使用<code>sort</code>方法对数据进行排序，<code>sort(&lt;param&gt;) </code>可以通过参数指定排序的字段，并使用<code>1</code>和<code>-1</code>来指定排序的方式，其中<code>1</code>为升序排列，而 <code>-1</code>是用于降序排列。</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.find().sort({age:&#39;asc&#39;})
</code></pre><h3 id="更新文档">更新文档</h3>
<h4 id="save更新文档">save更新文档</h4>
<p>save()函数的作用是保存文档，如果文档存在则覆盖，如果文档不存在则新增。<span style="color:red">save()函数对文档是否存在的唯一判断标准是<code>_id</code>系统唯一字段是否匹配。所以使用save()函数实现更新操作，则必须提供<code>_id</code>字段数据</span></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.save({name:&#34;赵六&#34;}); -- 新增
db.user.save({&#34;_id&#34; : ObjectId(&#34;6010c798fc86950278e5caac&#34;),name:&#34;赵六&#34;, age: 22}); --更新
</code></pre><h4 id="update更新文档">update更新文档</h4>
<p><code>update()</code>函数用于更新已存在的文档</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">语法：
db.&lt;collectionName&gt;.update(
    &lt;query&gt;,
    &lt;update&gt;,
    &lt;upsert:boolean&gt;,
    &lt;multi:boolean&gt;
)
</code></pre><ul>
<li>query：update的查询条件，类似sql的update更新语法内where后面的内容</li>
<li>update：update的对象和一些更新的操作符等，也可以理解为sql update查询内set后面的</li>
<li>upsert：可选，这个参数的意思是，如果不存在update的记录，是否插入这个document，true为插入，默认是false，不插入</li>
<li><span style="color:red">multi：可选，mongodb 默认是false，只更新找到的第一条记录，如果这个参数为true，就把按条件查出来多条记录全部更新。只有在表达式更新语法中才可使用。</span></li>
</ul>
<p>在MongoDB中的update是有两种更新方式，一种是覆盖更新，一种是表达式更新。</p>
<ul>
<li>覆盖更新：顾名思义，就是通过某条件，将新文档覆盖原有文档</li>
<li>表达式更新：这种更新方式是通过表达式来实现复杂更新操作，如：字段更新、数值计算、数组操作、字段名修改等</li>
</ul>
<h5 id="覆盖更新">覆盖更新</h5>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{name: &#39;张&#39;});
</code></pre><p>将会给第一条符合添加的数据覆盖，因为<code>multi</code>选项默认为false</p>
<h5 id="表达式更新">表达式更新</h5>
<p><strong>$inc</strong></p>
<p>作用：对一个数字字段的某个field增加value</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$inc: {age: 1}});
</code></pre><p><strong>$set</strong></p>
<p>作用：把文档中某个字段field的值设为value，如果field不存在，则增加新的字段并赋值为value</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$set: {age: 20}});
</code></pre><p><strong>$unset</strong></p>
<p>作用：删除某个字段field</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$unset: {age: null}});
</code></pre><p>unset指定的字段后可以跟任何值，只是起占位作用</p>
<p><strong>$push</strong></p>
<p><span style="color:red">作用：把value追加到field里。注：field只能是数组类型，如果field不存在，会自动插入一个数组类型</span></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$push: {course: &#39;vue&#39;}});
</code></pre><p><strong>$addToSet</strong></p>
<p>作用：加一个值到数组内，而且只有当这个值在数组中不存在时才增加</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$addToSet: {course: &#39;vue&#39;}});
</code></pre><p><strong>$pop</strong></p>
<p>删除数组内第一个值<code>{$pop:{&lt;field&gt;:-1}}</code>、删除数组内最后一个值<code>{$pop:{&lt;field&gt;:1}}</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$pop: {course: -1}});
</code></pre><p><strong>$pull</strong></p>
<p>从数组field内删除所有等于指定值的值</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$pull: {course: &#39;vue&#39;}});
</code></pre><p><strong>$pullAll</strong></p>
<p>用法同<code>$pull</code>一样，可以一次性删除数组内的多个值</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$pullAll: {course: [&#39;vue&#39;, &#39;java&#39;, &#39;spring&#39;]}});
</code></pre><p><strong>$rename</strong></p>
<p>作用：对字段进行重命名。底层实现是先删除old_field字段，再创建new_field字段</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.update({name: &#39;张三&#39;},{$rename: {nickName: &#39;nick&#39;}});
</code></pre><h3 id="删除文档">删除文档</h3>
<p><strong>deleteOne函数</strong></p>
<p>作用：删除一个满足添加的数据</p>
<p>语法：<code>db.&lt;collectionName&gt;.deleteOne({&lt;query&gt;})</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.deleteOne({&#39;name&#39;:&#39;张三&#39;});
</code></pre><p><strong>deleteMany函数</strong></p>
<p>作用：删除所有满足添加的数据</p>
<p>语法：<code>db.&lt;collectionName&gt;.deleteMany({&lt;query&gt;})</code></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.deleteMany({&#39;name&#39;:&#39;张三&#39;});
</code></pre><blockquote>
<p>删除文档还有一个remove函数，但已过时，官方推荐用deleteOne()和deleteMany()函数来实现删除操作。且在4.0版本中，remove函数并不会真正的释放存储空间，需要使用db.repairDatabase()函数来释放存储空间。</p>
</blockquote>
<h2 id="七内置函数">七、内置函数</h2>
<h4 id="aggregate函数">aggregate函数</h4>
<p>MongoDB中聚合的方法使用aggregate</p>
<p>语法：<code>db.&lt;collectionName&gt;.aggregate(&lt;agg_options&gt;)</code></p>
<p>agg_options：数组类型参数，传入具体的聚合表达式，此参数代表聚合规则，如计算总和、平均值、最大最小值等。</p>
<h4 id="求和sum">求和$sum</h4>
<p>语法：<code>db.collectionName.aggregate([{&quot;$group&quot;:{&quot;_id&quot;:&lt;field/null&gt;, &quot;&lt;aggeName&gt;&quot;:{&quot;$sum&quot;:&quot;$&lt;field&gt;&quot;}}}])</code></p>
<ul>
<li><code>$group</code>：分组，代表聚合的分组条件</li>
<li><code>_id</code>：分组的字段。相当于SQL分组语法group by column中的column部分。如果根据某字段的值分组，则定义为<code>_id:'$field'</code>。如果不需要分组则为<code>_id:null</code></li>
<li><code>$sum</code>：求和表达式。相当于SQL中的<code>sum</code>函数</li>
<li><code>$&lt;filed&gt;</code>：代表文档中的需要求和字段</li>
</ul>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$group:{_id: null, sum_age: {$sum: &#39;$age&#39;}}}]);     --不分组求和
db.user.aggregate([{$group:{_id: &#39;$name&#39;, sum_age: {$sum: &#39;$age&#39;}}}]);  --以name分组之后求和
</code></pre><h4 id="统计sum">统计$sum</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$group:{_id: null, count: {&#39;$sum&#39;: 1}}}]);     --不分组统计总数
db.user.aggregate([{$group:{_id: &#39;$name&#39;, count: {&#39;$sum&#39;: 1}}}]);  --以name分组之后统计总数
</code></pre><h4 id="最大值max">最大值$max</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$group:{_id: null, count: {&#39;$max&#39;: &#39;$age&#39;}}}]);     --不分组统计最大值
db.user.aggregate([{$group:{_id: &#39;$name&#39;, count: {&#39;$max&#39;: &#39;$age&#39;}}}]);  --以name分组之后统计最大值
</code></pre><h4 id="最小值min">最小值$min</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$group:{_id: null, count: {&#39;$min&#39;: &#39;$age&#39;}}}]);     --不分组统计最小值
db.user.aggregate([{$group:{_id: &#39;$name&#39;, count: {&#39;$min&#39;: &#39;$age&#39;}}}]);  --以name分组之后统计最小值
</code></pre><h4 id="平均值avg">平均值$avg</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$group:{_id: null, age_avg: {&#39;$avg&#39;: &#39;$age&#39;}}}]);     --不分组统计平均值
db.user.aggregate([{$group:{_id: &#39;$name&#39;, age_avg: {&#39;$min&#39;: &#39;$age&#39;}}}]);  --以name分组之后统计平均值
</code></pre><h4 id="字符串拼接">字符串拼接</h4>
<p>语法：<code>db.collection.aggregate([{&quot;$project&quot;:{&quot;&lt;result_name&gt;&quot;:{&quot;$concat&quot;:[&quot;$&lt;field&gt;&quot;,...]}}}])</code></p>
<p><span style="color:red">连接字段必须是字符串，否则报错</span></p>
<p><code>$project</code>：管道，进行字符串拼接处理，日期处理等操作的函数</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$project: {&#39;name-age&#39;:{$concat:[&#39;$name&#39;, &#39;-&#39;, &#39;$nickName&#39;]}}}]);
</code></pre><h4 id="字符串转大写">字符串转大写</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$project: {nameUpper:{$toUpper:&#39;$nickName&#39;}}}]);
</code></pre><h4 id="字符串转小写">字符串转小写</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$project: {nameUpper:{$toLower:&#39;$nickName&#39;}}}]);
</code></pre><h4 id="截取字符串">截取字符串</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$project: {nameSub:{$substr:[&#39;$nickName&#39;, 0, 3]}}}]);
</code></pre><h4 id="日期格式化">日期格式化</h4>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.insert({&#34;birthDate&#34;:ISODate(&#39;2020-01-01T10:10:10.000Z&#39;)})
db.user.aggregate([{$project: {birth: {$dateToString: {format: &#39;%Y年%m月%d日 %H:%M:%S&#39;, date: &#39;$birthDate&#39;}}}}]);
</code></pre><h4 id="条件过滤">条件过滤</h4>
<p><code>$match</code>：匹配条件，放在前面，相当于SQL中的where子句，代表聚合之前进行条件筛选。放在后面，相当于SQL中的having子句。代表聚合之后进行条件筛选，只能筛选聚合结果，不能筛选聚合条件。</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">示例：
db.user.aggregate([{$match: {age: {$lt: 20}}},{$group:{_id: null, count: {$sum: 1}}}]);
</code></pre><h2 id="八运算符">八、运算符</h2>
<p>在MongoDB中，数学类型（int/long/double）和日期类型（date）可以做数学运行。日期只能做加减。</p>
<p><strong>加法</strong></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.aggregate([{$project:{name: 1, new_age: {$add: [&#39;$age&#39;, 1]}}}]);
</code></pre><p><strong>减法</strong></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.aggregate([{$project:{name: 1, new_age: {$subtract: [&#39;$age&#39;, 1]}}}]);
</code></pre><p><strong>乘法</strong></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.aggregate([{$project:{name: 1, new_age: {$multiply: [&#39;$age&#39;, 1]}}}]);
</code></pre><p><strong>除法</strong></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.aggregate([{$project:{name: 1, new_age: {$divide: [&#39;$age&#39;, 1]}}}]);
</code></pre><p><strong>取模</strong></p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.user.aggregate([{$project:{name: 1, new_age: {$mod: [&#39;$age&#39;, 2]}}}]);
</code></pre><h2 id="九索引">九、索引</h2>
<p>在MongoDB3版本后，创建集合时默认为系统主键字段<code>_id</code>创建索引。且在关闭<code>_id</code>索引创建时会有警告提示。因为_id字段不创建索引，会导致Secondary在同步数据时负载变高。</p>
<h3 id="创建索引">创建索引</h3>
<p>语法：<code>db.&lt;collectionName&gt;.ensureIndex(&lt;keys&gt;, &lt;options&gt;)</code></p>
<ul>
<li>
<p>keys：用于创建索引的列及索引数据的排序规则。如：并升序索引<code>db.&lt;collectionName&gt;.ensureIndex({&lt;keyName&gt;:1})</code>、降序索引<code>db.&lt;collectionName&gt;.ensureIndex({&lt;keyName&gt;:-1})</code></p>
</li>
<li>
<p>options：创建索引时可定义的索引参数。可选参数如下</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>background</td>
<td>Boolean</td>
<td>默认false。建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引</td>
</tr>
<tr>
<td>unique</td>
<td>Boolean</td>
<td>默认false。建立的索引是否唯一，指定为true创建唯一索引</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>索引的名称。如果未指定默认生成<code>&lt;key&gt;_&lt;1/-1&gt;</code>的名称</td>
</tr>
<tr>
<td>sparse</td>
<td>Boolean</td>
<td>默认false，对文档中不存在的字段数据不启用索引</td>
</tr>
<tr>
<td>expireAfterSeconds</td>
<td>integer</td>
<td>指定一个以秒为单位的数值，完成 TTL设定，设定索引的生存时间</td>
</tr>
</tbody>
</table>
<p>如：<code>db.&lt;collectionName&gt;.ensureIndex({&lt;key&gt;:1}, {'background':true})</code></p>
</li>
</ul>
<h3 id="查看索引">查看索引</h3>
<p><strong>查看集合的索引信息</strong></p>
<p>语法：<code>db.&lt;collectionName&gt;.getIndexes()</code></p>
<p><strong>查看索引键</strong></p>
<p>语法：<code>db.&lt;collectionName&gt;.getIndexKeys()</code></p>
<p><strong>查看索引详情</strong></p>
<p>语法：<code>db.&lt;collectionName&gt;.getIndexSpecs();</code></p>
<p><strong>查看索引占用空间</strong></p>
<p>语法：<code>db.&lt;collectionName&gt;.totalIndexSize([is_detail])</code></p>
<p>is_detail为false则只显示索引的总大小，为true显示该集合中每个索引的大小及总大小</p>
<p><strong>删除指定索引</strong></p>
<p>语法：<code>db.&lt;collectionName&gt;.dropIndex('&lt;indexName&gt;')</code></p>
<p><strong>删除集合的所有自建索引</strong></p>
<p>语法：<code>db.&lt;collectionName&gt;.dropIndexes()</code></p>
<p>此函数只删除自建索引，不会删除MongoDB创建的<code>_id</code>索引</p>
<p><strong>重建索引</strong></p>
<p>在MongoDB中使用<code>reIndex</code>函数重建索引。重建索引可以减少索引存储空间，减少索引碎片，优化索引查询效率。一般在数据大量变化后，会使用重建索引来提升索引性能。</p>
<p>语法：<code>db.&lt;collectionName&gt;.reIndex()</code></p>
<h3 id="索引类型">索引类型</h3>
<p>MongoDB支持多种类型的索引，包括单字段索引、复合索引、多key索引、文本索引等，每种类型的索引有不同的使用场合</p>
<h4 id="单字段索引">单字段索引</h4>
<p><code>db.&lt;collectionName&gt;.ensureIndex({&lt;field&gt;:1});</code></p>
<p>上述语句针对<code>field</code>创建了单字段索引，其能加速对此字段的各种查询请求，是最常见的索引形式。MongoDB默认创建的id索引也是这种类型。</p>
<h4 id="交叉索引">交叉索引</h4>
<p>为一个集合的多个字段分别建立索引，在查询的时候通过多个字段作为查询条件，这种情况称为交叉索引。</p>
<p><code>db.&lt;collectionName&gt;.ensureIndex({&lt;field_1&gt;:1});</code></p>
<p><code>db.&lt;collectionName&gt;.ensureIndex({&lt;field_2&gt;:1});</code></p>
<p>交叉索引的查询效率较低，例如<code>db.&lt;collectionName&gt;.find({&lt;field_1&gt;:&lt;value_1&gt;, &lt;field_2&gt;: &lt;value_2&gt;})</code>。在使用时，当查询使用到多个字段的时候，尽量使用复合索引，而不是交叉索引</p>
<h4 id="复合组合聚合索引">复合|组合|聚合索引</h4>
<p>针对多个字段联合创建索引，先按第一个字段排序，第一个字段相同的文档按第二个字段排序</p>
<p><code>db.&lt;collectionName&gt;.ensureIndex({&lt;field_1&gt;:1, &lt;field_2&gt;:1})</code></p>
<blockquote>
<p>使用复合索引是需要注意最左前缀原则</p>
</blockquote>
<h4 id="多key索引">多key索引</h4>
<p>当索引的字段为数组时，创建出的索引称为多key索引，多key索引会为数组的每个元素建立一条索引</p>
<p>语法和建立一般索引一致<code>db.&lt;collectionName&gt;.ensureIndex( {&lt;arrayFiled&gt;: 1} )</code></p>
<h4 id="唯一索引">唯一索引</h4>
<p>保证索引对应的字段不会出现相同的值，比如_id索引就是唯一索引。如果唯一索引所在字段有重复数据写入时，抛出异常</p>
<p><code>db.&lt;collectionName&gt;.ensureIndex({&lt;field_1&gt;: 1}, {unique: true})</code></p>
<h4 id="部分索引">部分索引</h4>
<p>只针对符合某个特定条件的文档建立索引。部分索引就是带有过滤条件的索引，即索引只存在与某些文档之上</p>
<p>如：<code>db.&lt;collectionName&gt;.ensureIndex({&lt;field_1&gt;: 1},{partialFilterExpression: {field_1: {$gt: &lt;filterValue&gt;}}})</code></p>
<p>只有当字段<code>field_1</code>大于指定的<code>filterValue</code>才建立索引，且<code>field_1</code>查询值比<code>filterValue</code>大时才生效</p>
<p><span style="color:red">部分索引只为集合中那些满足指定的筛选条件的文档创建索引。如果你指定的partialFilterExpression和唯一约束、那么唯一性约束只适用于满足筛选条件的文档。具有唯一约束的部分索引不会阻止不符合唯一约束且不符合过滤条件的文档的插入。</span></p>
<h3 id="查询计划">查询计划</h3>
<p>语法：<code>db.&lt;collectionName&gt;.find(&lt;findContent&gt;).explain()</code></p>
<p><code>winningPlain.stage</code>为<code>COLLSCAN</code>则为全表扫描，<code>IXSCAN</code>时使用了索引</p>
<h2 id="十集群">十、集群</h2>
<h3 id="复制集replication-set">复制集（Replication Set）</h3>
<p>MongoDB的复制至少需要两个节点。其中一个是主节点，负责处理客户端请求，其余的都是从节点，负责复制主节点上的数据。建议提供仲裁节点，此节点不存储数据，作用是当主节点出现故障时，选举出某个备用节点成为主节点，保证MongoDB的正常服务。客户端只需要访问主节点或从节点，不需要访问仲裁节点。</p>
<p>主节点记录在其上的所有操作oplog（操作日志），从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致。</p>
<p>MongoDB各个节点常见的搭配方式为：一主一从一仲裁、一主多从一仲裁。</p>
<h4 id="环境准备">环境准备</h4>
<p>在一台主机上模拟使用单主机多端口的方式搭建复制集，1主2备1仲裁</p>
<p>①、创建数据目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p /opt/module/mongodb-replication-set/data/db-primary  主节点
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/mongodb-replication-set/data/db-s0       从节点
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/mongodb-replication-set/data/db-s1       从节点
</span></span><span style="display:flex;"><span>mkdir -p /opt/module/mongodb-replication-set/data/db-arbiter  仲裁节点
</span></span></code></pre></td></tr></table>
</div>
</div><p>②、创建配置目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /opt/module/mongodb-replication-set/etc    创建配置目录
</span></span><span style="display:flex;"><span>mkdir /opt/module/mongodb-replication-set/log    创建日志目录
</span></span><span style="display:flex;"><span>mkdir /opt/module/mongodb-replication-set/pids   创建进程文件目录
</span></span></code></pre></td></tr></table>
</div>
</div><p>③、配置文件</p>
<pre tabindex="0"><code class="language-config" data-lang="config"># Primary配置
vim /opt/module/mongodb-replication-set/etc/mongo-primary.conf
# 配置如下：
dbpath=/opt/module/mongodb-replication-set/data/db-primary          数据库目录
logpath=/opt/module/mongodb-replication-set/log/primary.log         日志文件
pidfilepath=/opt/module/mongodb-replication-set/pids/primary.pid    进程描述文件
bind_ip_all=true
directoryperdb=true                     为数据库自动提供重定向
logappend=true                          日志追加写入
replSet=rs                              复制集名称，一个复制集中的多个节点命名一致
port=37010                              端口
oplogSize=10000                         操作日志容量
fork=true                               后台启动

# Secondary-0配置
vim /opt/module/mongodb-replication-set/etc/mongo-s0.conf
# 配置如下：
dbpath=/opt/module/mongodb-replication-set/data/db-s0
logpath=/opt/module/mongodb-replication-set/log/secondary-0.log
pidfilepath=/opt/module/mongodb-replication-set/pids/secondary-0.pid
bind_ip_all=true
directoryperdb=true
logappend=true
replSet=rs
port=37011
oplogSize=10000
fork=true

# Secondary-1配置
vim /opt/module/mongodb-replication-set/etc/mongo-s1.conf
# 配置如下：
dbpath=/opt/module/mongodb-replication-set/data/db-s1
logpath=/opt/module/mongodb-replication-set/log/secondary-1.log
pidfilepath=/opt/module/mongodb-replication-set/pids/secondary-1.pid
bind_ip_all=true
directoryperdb=true
logappend=true
replSet=rs
port=37012
oplogSize=10000
fork=true

# Arbiter配置
vim /opt/module/mongodb-replication-set/etc/mongo-arbiter.conf
# 配置如下：
dbpath=/opt/module/mongodb-replication-set/data/db-arbiter
logpath=/opt/module/mongodb-replication-set/log/db-arbiter.log
pidfilepath=/opt/module/mongodb-replication-set/pids/db-arbiter.pid
bind_ip_all=true
directoryperdb=true
logappend=true
replSet=rs
port=37013
oplogSize=10000
fork=true
</code></pre><h4 id="启动各节点">启动各节点</h4>
<p>①、启动</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>bin/mongod --config /opt/module/mongodb-replication-set/etc/mongo-primary.conf
</span></span><span style="display:flex;"><span>bin/mongod --config /opt/module/mongodb-replication-set/etc/mongo-s0.conf
</span></span><span style="display:flex;"><span>bin/mongod --config /opt/module/mongodb-replication-set/etc/mongo-s1.conf
</span></span><span style="display:flex;"><span>bin/mongod --config /opt/module/mongodb-replication-set/etc/mongo-arbiter.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>②、访问主节点</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> bin/mongo --port <span style="color:#099">37010</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>③、初始化复制集</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">rs.initiate({
    # 复制集命名，与配置文件对应
    _id:&#34;rs&#34;,
    members:[
        # _id:唯一标记，host:主机地址，priority:权重（数字越大优先级越高），arbiterOnly:是否是仲裁节点
        {_id:0,host:&#34;127.0.0.1:37010&#34;,priority:3},
        {_id:1,host:&#34;127.0.0.1:37011&#34;,priority:1},
        {_id:2,host:&#34;127.0.0.1:37012&#34;,priority:1},
        {_id:3,host:&#34;127.0.0.1:37013&#34;,arbiterOnly:true}
    ]
});
</code></pre><p>④、查看状态</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">rs.status();
</code></pre><p>④、查看当前连接节点是否是Primary节点</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">rs.isMaster();
</code></pre><h4 id="总结">总结</h4>
<p>当主节点宕机时，仲裁节点会根据配置信息中的权重值优先选举权重高的节点作为主节点继续提供服务。当宕机的主节点恢复后，复制集会恢复原主节点状态，临时主节点重新成为从节点。默认情况下直接连接从节点是无法查询数据的。因为从节点是不可读的。如果需要在从节点上读取数据，则需要在从节点控制台输入命令<code>rs.slaveOk([true|false])</code>来设置。<code>rs.slaveOk()</code>或<code>rs.slaveOk(true)</code>代表可以在从节点上做读操作；<code>rs.slaveOk(false)</code>代表不可在从节点上做读操作。</p>
<h3 id="分片集群shard-cluster">分片集群（shard cluster）</h3>
<p>在Mongodb里面存在另一种集群，就是分片技术，可以满足MongoDB数据量大量增长的需求。当MongoDB存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据。</p>
<p>sharding方案将整个数据集拆分成多个更小的chunk，并分布在集群中多个mongod节点上，最终达到存储和负载能力扩容、压力分流的作用。在sharding架构中，每个负责存储一部分数据的mongod节点称为shard（分片），shard上分布的数据块称为chunk，collections可以根据<code>shard key</code>（称为分片键）将数据集拆分为多个chunks，并相对均衡的分布在多个shards上。</p>
<h4 id="各术语解释">各术语解释</h4>
<p><strong>Shard</strong></p>
<p>用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个replica set承担，防止主机单点故障</p>
<p><strong>Config Server</strong></p>
<p>mongod实例，存储了整个ClusterMetadata，其中包括chunk信息。</p>
<p><strong>Routers</strong></p>
<p>前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。</p>
<p><strong>Shard Key</strong></p>
<p>数据的分区根据<code>shard key</code>，对于每个需要sharding的collection，都需要指定<code>shard key</code>（分片键）；分片键必须是索引字段或者为组合索引的左前缀；mongodb根据分片键将数据分成多个chunks，并将它们均匀分布在多个shards节点上。目前，mongodb支持两种分区算法：区间分区（Range）和哈希（Hash）分区。</p>
<p><strong>Range分区</strong></p>
<p>首先<code>shard key</code>必须是数字类型或字符串类型（字符串类型根据索引排序作为分裂依据），整个区间的上下边界分别为正无穷大、负无穷大，每个chunk覆盖一段子区间，即整体而言，任何shard key均会被某个特定的chunk所覆盖。区间均为左闭右开。每个区间均不会有重叠覆盖，且互相临近。当然chunk并不是预先创建的，而是随着chunk数据的增大而不断split。</p>
<p><strong>Hash分区</strong></p>
<p>计算shard key的hash值（64位数字），并以此作为Range来分区。Hash值具有很强的散列能力，通常不同的shard key具有不同的hash值（冲突是有限的），这种分区方式可以将document更加随机的分散在不同的chunks上。</p>
<h4 id="搭建分片集群">搭建分片集群</h4>
<p>在一台主机上模拟使用单主机多端口的方式搭建集群，两个复制集（1主1备1仲裁），三个配置服务器（1主2备），一个路由节点</p>
<h5 id="环境准备-1">环境准备</h5>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb"># 分片0的3个节点的数据目录，RS复制集，1主1备1仲裁
mkdir -p /opt/module/mongodb-cluster/data/rs0/primary
mkdir -p /opt/module/mongodb-cluster/data/rs0/slave
mkdir -p /opt/module/mongodb-cluster/data/rs0/arbiter

# 分片1的3个节点的数据目录，RS复制集，1主1备1仲裁
mkdir -p /opt/module/mongodb-cluster/data/rs1/primary
mkdir -p /opt/module/mongodb-cluster/data/rs1/slave
mkdir -p /opt/module/mongodb-cluster/data/rs1/arbiter

# 配置服务器的3个节点的数据目录，RS复制集，1主2备
mkdir -p /opt/module/mongodb-cluster/data/cf/primary
mkdir -p /opt/module/mongodb-cluster/data/cf/s0
mkdir -p /opt/module/mongodb-cluster/data/cf/s1

# 创建配置目录
mkdir -p /opt/module/mongodb-cluster/etc
mkdir -p /opt/module/mongodb-cluster/log
mkdir -p /opt/module/mongodb-cluster/pids
</code></pre><h5 id="搭建shard">搭建Shard</h5>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb"># RS0的Primary配置
vim /opt/module/mongodb-cluster/etc/rs0-primary.conf
# 配置如下：
shardsvr=true                                        代表当前节点是一个shard节点。
dbpath=/opt/module/mongodb-cluster/data/rs0/primary
logpath=/opt/module/mongodb-cluster/log/rs0-primary.log
pidfilepath=/opt/module/mongodb-cluster/pids/rs0-primary.pid
bind_ip_all=true
logappend=true
replSet=rs0
port=27010
oplogSize=10000
fork=true

# RS0的Secondary配置
vim /opt/module/mongodb-cluster/etc/rs0-slave.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/rs0/slave
logpath=/opt/module/mongodb-cluster/log/rs0-slave.log
pidfilepath=/opt/module/mongodb-cluster/pids/rs0-slave.pid
bind_ip_all=true
shardsvr=true
logappend=true
replSet=rs0
port=27011
oplogSize=10000
fork=true

# RS0的arbiter配置
vim /opt/module/mongodb-cluster/etc/rs0-arbiter.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/rs0/arbiter
logpath=/opt/module/mongodb-cluster/log/rs0-arbiter.log
pidfilepath=/opt/module/mongodb-cluster/pids/rs0-arbiter.pid
bind_ip_all=true
shardsvr=true
logappend=true
replSet=rs0
port=27012
oplogSize=10000
fork=true

# RS1的Primary配置
vim /opt/module/mongodb-cluster/etc/rs1-primary.conf
# 配置如下：
shardsvr=true
dbpath=/opt/module/mongodb-cluster/data/rs1/primary
logpath=/opt/module/mongodb-cluster/log/rs1-primary.log
pidfilepath=/opt/module/mongodb-cluster/pids/rs1-primary.pid
bind_ip_all=true
logappend=true
replSet=rs1
port=27020
oplogSize=10000
fork=true

# RS1的Secondary配置
vim /opt/module/mongodb-cluster/etc/rs1-slave.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/rs1/slave
logpath=/opt/module/mongodb-cluster/log/rs1-slave.log
pidfilepath=/opt/module/mongodb-cluster/pids/rs1-slave.pid
bind_ip_all=true
shardsvr=true
logappend=true
replSet=rs1
port=27021
oplogSize=10000
fork=true

# RS1的arbiter配置
vim /opt/module/mongodb-cluster/etc/rs1-arbiter.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/rs1/arbiter
logpath=/opt/module/mongodb-cluster/log/rs1-arbiter.log
pidfilepath=/opt/module/mongodb-cluster/pids/rs1-arbiter.pid
bind_ip_all=true
shardsvr=true
logappend=true
replSet=rs1
port=27022
oplogSize=10000
fork=true
</code></pre><h5 id="启动shard">启动Shard</h5>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>bin/mongod --config etc/rs0-primary.conf
</span></span><span style="display:flex;"><span>bin/mongod --config etc/rs0-slave.conf
</span></span><span style="display:flex;"><span>bin/mongod --config etc/rs0-arbiter.conf
</span></span><span style="display:flex;"><span>bin/mongod --config etc/rs1-primary.conf
</span></span><span style="display:flex;"><span>bin/mongod --config etc/rs1-slave.conf
</span></span><span style="display:flex;"><span>bin/mongod --config etc/rs1-arbiter.conf
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="配置shard">配置Shard</h5>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">bin/mongo --port 27010
rs.initiate({
    _id:&#34;rs0&#34;,
    members:[
        {_id:0,host:&#34;127.0.0.1:27010&#34;,priority:2},
        {_id:1,host:&#34;127.0.0.1:27011&#34;,priority:1},
        {_id:3,host:&#34;127.0.0.1:27012&#34;,arbiterOnly:true}
    ]
});

bin/mongo --port 27020
rs.initiate({
    _id:&#34;rs1&#34;,
    members:[
        {_id:0,host:&#34;127.0.0.1:27020&#34;,priority:2},
        {_id:1,host:&#34;127.0.0.1:27021&#34;,priority:1},
        {_id:3,host:&#34;127.0.0.1:27022&#34;,arbiterOnly:true}
    ]
});
</code></pre><h5 id="搭建config-server">搭建Config Server</h5>
<p>config server的复制集中不允许有单仲裁节点。复制集初始化命令中，不允许设置arbiterOnly:true参数</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf"># Config Server的Primary配置
vim /opt/module/mongodb-cluster/etc/cf-primary.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/cf/primary
logpath=/opt/module/mongodb-cluster/log/cf-primary.log
pidfilepath=/opt/module/mongodb-cluster/pids/cf-primary.pid
bind_ip_all=true
logappend=true
replSet=cf
port=27030
oplogSize=10000
fork=true
configsvr=true                     代表当前节点是一个配置服务节点

# Config Server的s0配置
vim /opt/module/mongodb-cluster/etc/cf-s0.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/cf/s0
logpath=/opt/module/mongodb-cluster/log/cf-s0.log
pidfilepath=/opt/module/mongodb-cluster/pids/cf-s0.pid
bind_ip_all=true
logappend=true
replSet=cf
port=27031
oplogSize=10000
fork=true
configsvr=true

# Config Server的s1配置
vim /opt/module/mongodb-cluster/etc/cf-s1.conf
# 配置如下：
dbpath=/opt/module/mongodb-cluster/data/cf/s1
logpath=/opt/module/mongodb-cluster/log/cf-s1.log
pidfilepath=/opt/module/mongodb-cluster/pids/cf-s1.pid
bind_ip_all=true
logappend=true
replSet=cf
port=27032
oplogSize=10000
fork=true
configsvr=true
</code></pre><h5 id="启动config-server">启动Config Server</h5>
<pre tabindex="0"><code class="language-config" data-lang="config">bin/mongod --config etc/cf-primary.conf
bin/mongod --config etc/cf-s0.conf
bin/mongod --config etc/cf-s1.conf
</code></pre><h5 id="配置config-server">配置Config Server</h5>
<pre tabindex="0"><code class="language-config" data-lang="config">bin/mongo --port 27030
rs.initiate({
    _id:&#34;cf&#34;,
    members:[
        {_id:0,host:&#34;127.0.0.1:27030&#34;,priority:2},
        {_id:1,host:&#34;127.0.0.1:27031&#34;,priority:1},
        {_id:3,host:&#34;127.0.0.1:27032&#34;,priority:1}
    ]
});
</code></pre><h5 id="搭建router">搭建Router</h5>
<p>生成环境中通常提供多个，使用keepalive和haproxy实现高可用。router不需要数据库目录，不需要配置dbpath。</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">vim /opt/module/mongodb-cluster/etc/rt.conf
# 配置如下：
configdb=cf/127.0.0.1:27030,127.0.0.1:27031,127.0.0.1:27032
logpath=/opt/module/mongodb-cluster/log/rt.log
pidfilepath=/opt/module/mongodb-cluster/pids/rt.pid
port=27040
fork=true
bind_ip_all=true
</code></pre><h5 id="启动router">启动Router</h5>
<p>注意使用的是<code>mongos</code>命令</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>bin/mongos --config etc/rt.conf
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="配置router">配置Router</h5>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb"># 连接
bin/mongo --port 27040

# 进入admin库
use admin

# 加入分片信息
db.runCommand({&#39;addShard&#39;:&#39;rs0/127.0.0.1:27010,127.0.0.1:27011,127.0.0.1:27012&#39;});
db.runCommand({&#39;addShard&#39;:&#39;rs1/127.0.0.1:27020,127.0.0.1:27021,127.0.0.1:27022&#39;});
</code></pre><h5 id="开启shard">开启Shard</h5>
<p>首先需要将Database开启sharding，否则数据仍然无法在集群中分布。即数据库、collection默认为non-sharding。对于non-sharding的database或者collection均会保存在primary shard上，直到开启sharding才会在集群中分布。</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb"># 创建测试库
use test
# 开启Shard，开启分片命令必须在admin库下运行。
use admin
db.runCommand({ enablesharding: &#39;test&#39;})

# collection开启sharding，在此之前需要先指定shard key和建立&#34;shard key索引&#34;
use test
db.users.ensureIndex({&#39;_id&#39;:&#39;hashed&#39;});
db.runCommand({ shardcollection: &#39;test.users&#39;, key: {&#39;_id&#39;: &#39;hashed&#39;}})

# users集合将使用&#34;_id&#34;作为第一维shard key，采用hashed分区模式，可以通过sh.status()查看每个chunk的分裂区间
sh.status()
</code></pre><p>在GridFS开启Shard</p>
<pre tabindex="0"><code class="language-mongodb" data-lang="mongodb">db.runCommand( { shardCollection : &#34;test.fs.chunks&#34; , key : {  files_id : 1 } } )
# 在GridFS中，对chunks集合进行分片时，只有两个片键可以选择，{ files_id : 1 , n : 1 } 与 {  files_id : 1 }
</code></pre><h2 id="十一spring-data-mongodb">十一、Spring Data Mongodb</h2>
<p><strong>第一步：引入依赖</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-data-mongodb<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第二步：配置YAML</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">mongodb</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">database</span>:<span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">host</span>:<span style="color:#bbb"> </span><span style="color:#099">192.168.22.161</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">27017</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#998;font-style:italic"># 如果需要认证需要下面三行</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">authentication-database</span>:<span style="color:#bbb"> </span>admin<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">password</span>:<span style="color:#bbb"> </span>root<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">username</span>:<span style="color:#bbb"> </span>root<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第三步：建立实体类</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Document</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@Data</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 如果是集群模式需要指定Shard </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@Sharded</span>(shardKey<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>{<span style="color:#d14">&#34;_id&#34;</span>},<span style="color:#bbb"> </span>shardingStrategy<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>ShardingStrategy.<span style="color:#008080">HASH</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Student</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 指定ID，如果是String或者ObjectId可自动生成ID</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 注意String使用自动生成时更新操作无法进行</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@MongoId</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>ObjectId<span style="color:#bbb"> </span>id;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 如果字段名和数据库名称不一致需要指定</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#3c5d5d;font-weight:bold">@Field</span>(name<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;name&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>Integer<span style="color:#bbb"> </span>age;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>Boolean<span style="color:#bbb"> </span>isMan;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">private</span><span style="color:#bbb"> </span>List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>course;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建文档">创建文档</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 添加文档</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">addDocument</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setName</span>(<span style="color:#d14">&#34;kun&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setAge</span>(18);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setIsMan</span>(<span style="color:#000;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>res<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">insert</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// ID不存在时Save可用于新增文档</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// Student res = mongoTemplate.save(student);</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(res);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 批量添加文档</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">addDocuments</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setName</span>(<span style="color:#d14">&#34;kun&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setAge</span>(18);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setIsMan</span>(<span style="color:#000;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setCourse</span>(Arrays.<span style="color:#008080">asList</span>(<span style="color:#d14">&#34;spring&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;java&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;mysql&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>students.<span style="color:#008080">add</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setName</span>(<span style="color:#d14">&#34;jack&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setAge</span>(18);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setIsMan</span>(<span style="color:#000;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setCourse</span>(Arrays.<span style="color:#008080">asList</span>(<span style="color:#d14">&#34;php&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;mysql&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>students.<span style="color:#008080">add</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setName</span>(<span style="color:#d14">&#34;lily&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setAge</span>(16);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setIsMan</span>(<span style="color:#000;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setCourse</span>(Arrays.<span style="color:#008080">asList</span>(<span style="color:#d14">&#34;vue&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;php&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>students.<span style="color:#008080">add</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setName</span>(<span style="color:#d14">&#34;jane&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setAge</span>(18);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setIsMan</span>(<span style="color:#000;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setCourse</span>(Arrays.<span style="color:#008080">asList</span>(<span style="color:#d14">&#34;html&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;js&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>students.<span style="color:#008080">add</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>mongoTemplate.<span style="color:#008080">insertAll</span>(students);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="更新文档-1">更新文档</h3>
<ul>
<li>
<p>使用save修改（覆盖更新）</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">saveUpdateDocument</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setId</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>ObjectId(<span style="color:#d14">&#34;601253d33f108b62de913d54&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setName</span>(<span style="color:#d14">&#34;kun&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setAge</span>(20);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// ID存在时Save可用于更新文档</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>res<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">save</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(res);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用运算符实现（表达式更新）</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">expressUpdateDocument</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 查询对象</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Query<span style="color:#bbb"> </span>query<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>criteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;name&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#d14">&#34;kun&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>query.<span style="color:#008080">addCriteria</span>(criteria);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 更新字段</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Update<span style="color:#bbb"> </span>update<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Update();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>update.<span style="color:#008080">inc</span>(<span style="color:#d14">&#34;age&#34;</span>,<span style="color:#bbb"> </span>1);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// updateFirst为更新第一个匹配文档</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>UpdateResult<span style="color:#bbb"> </span>updateResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">updateMulti</span>(query,<span style="color:#bbb"> </span>update,<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(updateResult.<span style="color:#008080">getModifiedCount</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="删除文档-1">删除文档</h3>
<ul>
<li>
<p>根据主键删除</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">deleteDocument</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Student();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>student.<span style="color:#008080">setId</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>ObjectId(<span style="color:#d14">&#34;601253d33f108b62de913d54&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DeleteResult<span style="color:#bbb"> </span>deleteResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">remove</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(deleteResult.<span style="color:#008080">getDeletedCount</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>根据条件进行删除</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">deleteDocumentByCondition</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>criteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;name&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#d14">&#34;kun&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>DeleteResult<span style="color:#bbb"> </span>deleteResult<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">remove</span>(Query.<span style="color:#008080">query</span>(criteria),<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(deleteResult.<span style="color:#008080">getDeletedCount</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="查询文档-1">查询文档</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 查询全部文档</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findAll</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">findAll</span>(Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 查询单个对象，如果有多个结果只返回第一个</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findOne</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>criteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;name&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#d14">&#34;kun&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">findOne</span>(Query.<span style="color:#008080">query</span>(criteria),Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 带有条件的查询多个</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findByCondition</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Query<span style="color:#bbb"> </span>query<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query(Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;age&#34;</span>).<span style="color:#008080">gte</span>(3));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(query,<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 根据主键进行查询</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findById</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">findById</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>ObjectId(<span style="color:#d14">&#34;601266467bb99058c4fc58d6&#34;</span>),<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 根据字段是否为空进行查询</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findByIsNull</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Query<span style="color:#bbb"> </span>query<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query(Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;course&#34;</span>).<span style="color:#008080">exists</span>(<span style="color:#000;font-weight:bold">true</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(query,<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 根据正则查询</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findByReg</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>criteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;name&#34;</span>).<span style="color:#008080">regex</span>(<span style="color:#d14">&#34;.*n$&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(Query.<span style="color:#008080">query</span>(criteria),<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 多条件查询</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findByMultiAndCondition</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>criteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Criteria();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>ageCriteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;age&#34;</span>).<span style="color:#008080">lt</span>(20);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>isManCriteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;isMan&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#000;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>criteria.<span style="color:#008080">andOperator</span>(ageCriteria,<span style="color:#bbb"> </span>isManCriteria);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(Query.<span style="color:#008080">query</span>(criteria),<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findByMultiOrCondition</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>criteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Criteria();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>ageCriteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;age&#34;</span>).<span style="color:#008080">lt</span>(20);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Criteria<span style="color:#bbb"> </span>isManCriteria<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;isMan&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#000;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>criteria.<span style="color:#008080">orOperator</span>(ageCriteria,<span style="color:#bbb"> </span>isManCriteria);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(Query.<span style="color:#008080">query</span>(criteria),<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>students.<span style="color:#008080">stream</span>().<span style="color:#008080">forEach</span>(System.<span style="color:#008080">out</span>::println);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 查询去重复结果</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findDistinct</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 第一个参数： 查询条件query</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 第二个参数： 根据哪个属性去重复</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 第三个参数： 属性所在实体类</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 第四个参数： 属性的类型，此类型作为结果中List集合的泛型</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Integer<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>ages<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">findDistinct</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query(),<span style="color:#bbb"> </span><span style="color:#d14">&#34;age&#34;</span>,<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>,<span style="color:#bbb"> </span>Integer.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 结果排序</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findSort</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Query<span style="color:#bbb"> </span>query<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>query.<span style="color:#008080">with</span>(Sort.<span style="color:#008080">by</span>(Sort.<span style="color:#008080">Direction</span>.<span style="color:#008080">DESC</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;age&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(query,<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 结果分页</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">findPage</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Query<span style="color:#bbb"> </span>query<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 第一个参数Page，从0开始</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 第二个参数Size</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>query.<span style="color:#008080">with</span>(PageRequest.<span style="color:#008080">of</span>(1,<span style="color:#bbb"> </span>2));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>List<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">find</span>(query,<span style="color:#bbb"> </span>Student.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="聚合操作">聚合操作</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 统计总数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">aggCount</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TypedAggregation<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>aggregation<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>TypedAggregation.<span style="color:#008080">newAggregation</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Student.<span style="color:#008080">class</span>,<span style="color:#bbb">                                                                     
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Aggregation.<span style="color:#008080">group</span>().<span style="color:#008080">count</span>().<span style="color:#008080">as</span>(<span style="color:#d14">&#34;count&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>AggregationResults<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>results<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">aggregate</span>(aggregation,<span style="color:#bbb"> </span>Map.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(results.<span style="color:#008080">getUniqueMappedResult</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(results.<span style="color:#008080">getUniqueMappedResult</span>().<span style="color:#008080">get</span>(<span style="color:#d14">&#34;count&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 分组统计总数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">aggCountByGroup</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TypedAggregation<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>aggregation<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>TypedAggregation.<span style="color:#008080">newAggregation</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Student.<span style="color:#008080">class</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Aggregation.<span style="color:#008080">group</span>(<span style="color:#d14">&#34;name&#34;</span>).<span style="color:#008080">count</span>().<span style="color:#008080">as</span>(<span style="color:#d14">&#34;count&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>AggregationResults<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>results<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">aggregate</span>(aggregation,<span style="color:#bbb"> </span>Map.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 返回的_id 代表分组字段，如果字段有多个则_id为Map（key为字段名，value为值）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(Map<span style="color:#bbb"> </span>mappedResult<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>results.<span style="color:#008080">getMappedResults</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(mappedResult.<span style="color:#008080">get</span>(<span style="color:#d14">&#34;_id&#34;</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span><span style="color:#d14">&#34; - &#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>mappedResult.<span style="color:#008080">get</span>(<span style="color:#d14">&#34;count&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 具有条件的分组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">aggCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>TypedAggregation<span style="color:#000;font-weight:bold">&lt;</span>Student<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>aggregation<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>TypedAggregation.<span style="color:#008080">newAggregation</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Student.<span style="color:#008080">class</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Aggregation.<span style="color:#008080">match</span>(Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;age&#34;</span>).<span style="color:#008080">gt</span>(16)),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Aggregation.<span style="color:#008080">group</span>().<span style="color:#008080">count</span>().<span style="color:#008080">as</span>(<span style="color:#d14">&#34;count&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>AggregationResults<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>results<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mongoTemplate.<span style="color:#008080">aggregate</span>(aggregation,<span style="color:#bbb"> </span>Map.<span style="color:#008080">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(results.<span style="color:#008080">getUniqueMappedResult</span>().<span style="color:#008080">get</span>(<span style="color:#d14">&#34;count&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gridfs操作">GridFS操作</h3>
<p>GirdFS是MongoDB提供的用于持久化存储文件的模块。在GridFS存储文件是将文件分块存储，文件会按照256KB的大小分割成多个块进行存储，GridFS使用两个集合（collection）存储文件，从GridFS中读取文件要对文件的各各块进行组装、合并。</p>
<ul>
<li>一个集合是chunks，用于存储文件的二进制数据</li>
<li>一个集合是files，用于存储文件的元数 据信息(文件名称、块大小、上传时间等信息)</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 上传文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">gridFsUpload</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//选择要存储的文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>File<span style="color:#bbb"> </span>file<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#d14">&#34;C:\\Users\\kun\\Desktop\\TIM截图.png&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>InputStream<span style="color:#bbb"> </span>inputStream<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>FileInputStream(file);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//存储文件并起名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>ObjectId<span style="color:#bbb"> </span>objectId<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>gridFsTemplate.<span style="color:#008080">store</span>(inputStream,<span style="color:#bbb"> </span><span style="color:#d14">&#34;TIM截图.png&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#bbb"> </span>id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>objectId.<span style="color:#008080">toString</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//获取到文件的id，可以从数据库中查找</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#008080">out</span>.<span style="color:#008080">println</span>(id);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">// 查询下载文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">queryFile</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// 根据id查找文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">// GridFSFile gridFSFile = gridFsTemplate.findOne(</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//    new Query(Criteria.where(&#34;_id&#34;).is(&#34;60136de452d6203936d1b035&#34;)));</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>GridFSFile<span style="color:#bbb"> </span>gridFSFile<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>gridFsTemplate.<span style="color:#008080">findOne</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>Query(Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;filename&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#d14">&#34;TIM截图.png&#34;</span>)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//打开下载流对象</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>GridFSDownloadStream<span style="color:#bbb"> </span>gridFS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>gridFSBucket.<span style="color:#008080">openDownloadStream</span>(gridFSFile.<span style="color:#008080">getObjectId</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//创建gridFsSource，用于获取流对象</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>GridFsResource<span style="color:#bbb"> </span>gridFsResource<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>GridFsResource(gridFSFile,gridFS);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>File<span style="color:#bbb"> </span>file<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#d14">&#34;D:\\&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>gridFsResource.<span style="color:#008080">getFilename</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>IoUtil.<span style="color:#008080">copy</span>(<span style="color:#bbb"> </span>gridFsResource.<span style="color:#008080">getInputStream</span>(),<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>FileOutputStream(file));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">//删除文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">delFile</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">//根据文件id删除fs.files和fs.chunks中的记录</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>gridFsTemplate.<span style="color:#008080">delete</span>(Query.<span style="color:#008080">query</span>(Criteria.<span style="color:#008080">where</span>(<span style="color:#d14">&#34;_id&#34;</span>).<span style="color:#008080">is</span>(<span style="color:#d14">&#34;6013678f7d212159fe3a0a64&#34;</span>)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    

    <div class="container-comment-giscus">
        <script src="https://giscus.app/client.js"
        data-repo="loveminimal/comment"
        data-repo-id="R_kgDOJNJQ8g"
        data-category="General"
        data-category-id="DIC_kwDOJNJQ8s4CYl0m"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="noborder_light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
        </script>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    

    <div class="beian">
        
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41092802000242">
            

        </a>

        
        <a href="//beian.miit.gov.cn" target="_blank">
            
            <span class="some">icp...<span>
            
        </a>
    </div>

    
    <div class="info">
        
        <a href="https://github.com/loveminimal/hugo-theme-virgo">🕊️</a> 2016 - <span id="info-date"></span>
    </div>

</div></div>
        <div class="cool-after" style="
            
                background-color: rgba(255, 255, 255, 0.49); 
                backdrop-filter: saturate(100%) blur(6px);
            
            "></div>
    </body>
</html>
